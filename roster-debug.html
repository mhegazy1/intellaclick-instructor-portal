<!DOCTYPE html>
<html>
<head>
    <title>Roster Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        pre {
            background: #1e293b;
            color: #f1f5f9;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        .error { color: #ef4444; }
        .success { color: #10b981; }
        .warning { color: #f59e0b; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background: #f9fafb;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <h1>Roster Debug Tool</h1>
    
    <div class="section">
        <h2>Class Selection</h2>
        <p>Select a class to debug roster loading:</p>
        <select id="classSelect" onchange="loadRosterDebug()">
            <option value="">-- Select a class --</option>
        </select>
    </div>
    
    <div class="section">
        <h2>Debug Results</h2>
        <pre id="results">Select a class to begin debugging...</pre>
    </div>

    <div class="section">
        <h2>Enrollment Details</h2>
        <div id="enrollmentTable"></div>
    </div>

    <script>
        const API_URL = 'https://api.intellaclick.com';
        const resultsEl = document.getElementById('results');
        const tableEl = document.getElementById('enrollmentTable');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#64748b';
            resultsEl.innerHTML += `<span style="color: ${color}">${timestamp}: ${message}</span>\n`;
        }
        
        function clearResults() {
            resultsEl.innerHTML = '';
            tableEl.innerHTML = '';
        }
        
        async function makeRequest(endpoint, options = {}) {
            const token = localStorage.getItem('token');
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            };
            
            try {
                const response = await fetch(`${API_URL}${endpoint}`, {
                    ...defaultOptions,
                    ...options,
                    headers: {
                        ...defaultOptions.headers,
                        ...options.headers
                    }
                });
                
                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    data = { rawResponse: text };
                }
                
                return { response, data };
            } catch (error) {
                return { error: error.message };
            }
        }
        
        // Load classes on page load
        async function loadClasses() {
            const classesResult = await makeRequest('/api/classes');
            
            if (classesResult.response && classesResult.response.ok) {
                const select = document.getElementById('classSelect');
                select.innerHTML = '<option value="">-- Select a class --</option>';
                
                classesResult.data.classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls._id;
                    option.textContent = `${cls.name} (${cls.enrollmentCount || 0} students)`;
                    select.appendChild(option);
                });
            }
        }
        
        async function loadRosterDebug() {
            const classId = document.getElementById('classSelect').value;
            if (!classId) return;
            
            clearResults();
            log('Starting roster debug...\n');
            
            // Step 1: Check class details
            log('=== STEP 1: Class Details ===');
            const classResult = await makeRequest(`/api/classes/${classId}`);
            
            if (classResult.response && classResult.response.ok) {
                log('Class loaded successfully', 'success');
                // Log the actual response structure
                log(`Raw response: ${JSON.stringify(classResult.data, null, 2)}`);
                
                // Handle different possible response structures
                const classData = classResult.data.class || classResult.data;
                log(`Name: ${classData.name}`);
                log(`Join Code: ${classData.joinCode}`);
                log(`Enrollment Count: ${classData.enrollmentCount || classData.stats?.enrolledCount || 0}`);
                log(`Created: ${classData.createdAt ? new Date(classData.createdAt).toLocaleDateString() : 'Unknown'}`);
                
                // Show enrollment summary if available
                if (classData.enrollmentSummary) {
                    log('\nEnrollment Summary:');
                    log(`Total Enrolled: ${classData.enrollmentSummary.totalEnrolled}`);
                    log(`Active Students: ${classData.enrollmentSummary.activeStudents}`);
                    log(`Enrolled: ${classData.enrollmentSummary.enrolled}`);
                }
            } else {
                log('Failed to load class', 'error');
                log(`Error: ${JSON.stringify(classResult.data)}`, 'error');
                return;
            }
            
            // Step 2: Try the roster endpoint
            log('\n=== STEP 2: Roster Endpoint ===');
            log(`Calling: /api/enrollment/class/${classId}/students`);
            
            const rosterResult = await makeRequest(`/api/enrollment/class/${classId}/students`);
            
            if (rosterResult.error) {
                log(`Network error: ${rosterResult.error}`, 'error');
                return;
            }
            
            log(`Response status: ${rosterResult.response.status}`);
            
            if (rosterResult.response.ok) {
                log('Roster loaded successfully!', 'success');
                const enrollments = rosterResult.data.enrollments || [];
                log(`Found ${enrollments.length} enrollments`);
                
                if (enrollments.length > 0) {
                    // Display enrollment details
                    displayEnrollments(enrollments);
                }
            } else {
                log('Failed to load roster', 'error');
                log(`Error response: ${JSON.stringify(rosterResult.data, null, 2)}`, 'error');
                
                // Step 3: Try alternative endpoints
                log('\n=== STEP 3: Alternative Endpoints ===');
                
                // Add more detail about the error
                if (rosterResult.response && rosterResult.response.status === 403) {
                    log('Access denied - checking authorization details...', 'warning');
                    log(`Token exists: ${!!localStorage.getItem('token')}`);
                    log(`User role from localStorage: ${JSON.parse(localStorage.getItem('user') || '{}').role}`);
                }
                
                // Try getting enrollments directly
                log('Trying: /api/enrollment/by-class/' + classId);
                const altResult = await makeRequest(`/api/enrollment/by-class/${classId}`);
                
                if (altResult.response && altResult.response.ok) {
                    log('Alternative endpoint worked!', 'success');
                    log(`Response: ${JSON.stringify(altResult.data, null, 2)}`);
                } else {
                    log('Alternative endpoint also failed', 'error');
                    if (altResult.response) {
                        log(`Status: ${altResult.response.status}`, 'error');
                    }
                }
                
                // Try a simple enrollment count
                log('\nTrying: /api/classes/' + classId + '/enrollment-count');
                const countResult = await makeRequest(`/api/classes/${classId}/enrollment-count`);
                
                if (countResult.response && countResult.response.ok) {
                    log('Count endpoint worked!', 'success');
                    log(`Count: ${JSON.stringify(countResult.data)}`);
                } else {
                    log('Count endpoint failed', 'error');
                }
            }
            
            // Step 4: Check authentication
            log('\n=== STEP 4: Authentication Check ===');
            const meResult = await makeRequest('/api/auth/me');
            
            if (meResult.response && meResult.response.ok) {
                const userData = meResult.data.user || meResult.data;
                log(`User: ${userData.email}`);
                log(`Role: ${userData.role}`);
                log(`ID: ${userData.id || userData._id}`);
            } else {
                log('Failed to get user info', 'error');
            }
            
            log('\n=== DEBUG COMPLETE ===');
        }
        
        function displayEnrollments(enrollments) {
            let html = '<h3>Enrolled Students</h3>';
            html += '<table>';
            html += '<thead><tr><th>Name</th><th>Email</th><th>Status</th><th>Enrolled Date</th></tr></thead>';
            html += '<tbody>';
            
            enrollments.forEach(enrollment => {
                const student = enrollment.studentId || {};
                const profile = student.profile || {};
                const name = profile.firstName && profile.lastName 
                    ? `${profile.firstName} ${profile.lastName}` 
                    : student.name || 'Unknown';
                const email = student.email || 'No email';
                const status = enrollment.status || 'Unknown';
                const date = enrollment.enrolledAt 
                    ? new Date(enrollment.enrolledAt).toLocaleDateString() 
                    : 'Unknown';
                
                html += `<tr>
                    <td>${name}</td>
                    <td>${email}</td>
                    <td>${status}</td>
                    <td>${date}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            tableEl.innerHTML = html;
        }
        
        // Load classes when page loads
        document.addEventListener('DOMContentLoaded', loadClasses);
    </script>
</body>
</html>