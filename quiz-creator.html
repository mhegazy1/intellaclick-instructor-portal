<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Quiz - IntellaClick</title>
    <style>
        :root {
            --primary-color: #4F46E5;
            --primary-hover: #4338CA;
            --secondary-color: #10B981;
            --danger-color: #EF4444;
            --background: #F9FAFB;
            --surface: #FFFFFF;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --border: #E5E7EB;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background-color: var(--surface);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        .btn-secondary {
            background-color: #E5E7EB;
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background-color: #D1D5DB;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-success {
            background-color: var(--secondary-color);
            color: white;
        }

        .section {
            background-color: var(--surface);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        input[type="text"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .question-card {
            background-color: #F9FAFB;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .question-number {
            font-weight: 600;
            font-size: 16px;
            color: var(--primary-color);
        }

        .question-actions {
            display: flex;
            gap: 8px;
        }

        .option-group {
            margin-top: 12px;
        }

        .option-item {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 8px;
        }

        .option-item input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .option-item input[type="text"] {
            flex: 1;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .message {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background-color: #D1FAE5;
            color: #065F46;
            border: 1px solid #6EE7B7;
        }

        .message.error {
            background-color: #FEE2E2;
            color: #991B1B;
            border: 1px solid #FCA5A5;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .back-link {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 14px;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <a href="/classes.html" class="back-link">‚Üê Back to Classes</a>
                <h1 id="pageTitle">Create Quiz</h1>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="cancelQuiz()">Cancel</button>
                <button class="btn btn-success" onclick="saveQuiz()">Save Quiz</button>
            </div>
        </div>

        <div id="message" class="message"></div>

        <!-- Quiz Basic Info -->
        <div class="section">
            <h2 style="margin-bottom: 20px;">Quiz Information</h2>
            <div class="form-group">
                <label for="quizTitle">Quiz Title *</label>
                <input type="text" id="quizTitle" placeholder="Enter quiz title" required>
            </div>
            <div class="form-group">
                <label for="quizDescription">Description</label>
                <textarea id="quizDescription" placeholder="Enter quiz description (optional)"></textarea>
            </div>
        </div>

        <!-- Quiz Settings -->
        <div class="section">
            <h2 style="margin-bottom: 20px;">Settings</h2>
            <div class="settings-grid">
                <div class="form-group">
                    <label for="timeLimit">Time Limit (minutes)</label>
                    <input type="number" id="timeLimit" value="0" min="0" placeholder="0 = No limit">
                </div>
                <div class="form-group">
                    <label for="passingScore">Passing Score (%)</label>
                    <input type="number" id="passingScore" value="70" min="0" max="100">
                </div>
            </div>
            <div class="settings-grid">
                <div class="checkbox-group">
                    <input type="checkbox" id="shuffleQuestions">
                    <label for="shuffleQuestions" style="margin: 0;">Shuffle Questions</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="showResults" checked>
                    <label for="showResults" style="margin: 0;">Show Results</label>
                </div>
            </div>
        </div>

        <!-- Questions Section -->
        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Questions</h2>
                <button class="btn btn-primary" onclick="addQuestion()">+ Add Question</button>
            </div>

            <div id="questionsContainer">
                <div class="empty-state">
                    <p>No questions yet. Click "Add Question" to get started.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://api.intellaclick.com';
        let questions = [];
        let editingQuizId = null;

        // Check if editing existing quiz
        const urlParams = new URLSearchParams(window.location.search);
        editingQuizId = urlParams.get('id');

        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            if (editingQuizId) {
                loadQuizForEdit(editingQuizId);
            }
        });

        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
            }
        }

        async function loadQuizForEdit(quizId) {
            try {
                const response = await fetch(`${API_URL}/api/quizzes/${quizId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();
                if (data.success && data.quiz) {
                    document.getElementById('pageTitle').textContent = 'Edit Quiz';
                    document.getElementById('quizTitle').value = data.quiz.title;
                    document.getElementById('quizDescription').value = data.quiz.description || '';
                    document.getElementById('timeLimit').value = data.quiz.settings?.timeLimit || 0;
                    document.getElementById('passingScore').value = data.quiz.settings?.passingScore || 70;
                    document.getElementById('shuffleQuestions').checked = data.quiz.settings?.shuffleQuestions || false;
                    document.getElementById('showResults').checked = data.quiz.settings?.showResults !== false;

                    // Load questions
                    questions = (data.quiz.questions || []).map(q => ({
                        text: q.questionSnapshot?.questionText || '',
                        options: q.questionSnapshot?.options || ['', '', '', ''],
                        correctAnswer: q.questionSnapshot?.correctAnswer || 0,
                        points: q.points || 1
                    }));

                    renderQuestions();
                }
            } catch (error) {
                showMessage('Failed to load quiz for editing', 'error');
                console.error('Error loading quiz:', error);
            }
        }

        function addQuestion() {
            questions.push({
                text: '',
                options: ['', '', '', ''],
                correctAnswer: 0,
                points: 1
            });
            renderQuestions();
        }

        function removeQuestion(index) {
            if (confirm('Are you sure you want to remove this question?')) {
                questions.splice(index, 1);
                renderQuestions();
            }
        }

        function renderQuestions() {
            const container = document.getElementById('questionsContainer');

            if (questions.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No questions yet. Click "Add Question" to get started.</p></div>';
                return;
            }

            container.innerHTML = questions.map((q, index) => `
                <div class="question-card">
                    <div class="question-header">
                        <span class="question-number">Question ${index + 1}</span>
                        <div class="question-actions">
                            <button class="btn btn-danger btn-small" onclick="removeQuestion(${index})">Remove</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Question Text *</label>
                        <input type="text"
                               placeholder="Enter your question"
                               value="${q.text}"
                               onchange="updateQuestion(${index}, 'text', this.value)">
                    </div>

                    <div class="form-group">
                        <label>Answer Options (select the correct answer)</label>
                        <div class="option-group">
                            ${q.options.map((opt, optIndex) => `
                                <div class="option-item">
                                    <input type="radio"
                                           name="correct_${index}"
                                           ${q.correctAnswer === optIndex ? 'checked' : ''}
                                           onchange="updateQuestion(${index}, 'correctAnswer', ${optIndex})">
                                    <input type="text"
                                           placeholder="Option ${optIndex + 1}"
                                           value="${opt}"
                                           onchange="updateOption(${index}, ${optIndex}, this.value)">
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Points</label>
                        <input type="number"
                               value="${q.points}"
                               min="1"
                               style="width: 100px;"
                               onchange="updateQuestion(${index}, 'points', parseInt(this.value))">
                    </div>
                </div>
            `).join('');
        }

        function updateQuestion(index, field, value) {
            questions[index][field] = value;
        }

        function updateOption(questionIndex, optionIndex, value) {
            questions[questionIndex].options[optionIndex] = value;
        }

        async function saveQuiz() {
            const title = document.getElementById('quizTitle').value.trim();

            if (!title) {
                showMessage('Please enter a quiz title', 'error');
                return;
            }

            if (questions.length === 0) {
                showMessage('Please add at least one question', 'error');
                return;
            }

            // Validate all questions have text and options
            for (let i = 0; i < questions.length; i++) {
                if (!questions[i].text.trim()) {
                    showMessage(`Question ${i + 1} is missing text`, 'error');
                    return;
                }
                if (questions[i].options.every(opt => !opt.trim())) {
                    showMessage(`Question ${i + 1} needs at least one option`, 'error');
                    return;
                }
            }

            const quizData = {
                title,
                description: document.getElementById('quizDescription').value,
                type: 'standard',
                settings: {
                    timeLimit: parseInt(document.getElementById('timeLimit').value) || 0,
                    passingScore: parseInt(document.getElementById('passingScore').value) || 70,
                    shuffleQuestions: document.getElementById('shuffleQuestions').checked,
                    showResults: document.getElementById('showResults').checked
                },
                questions: questions.map((q, index) => ({
                    order: index,
                    points: q.points,
                    questionSnapshot: {
                        questionText: q.text,
                        type: 'multiple_choice',
                        options: q.options.filter(opt => opt.trim()),
                        correctAnswer: q.correctAnswer
                    }
                }))
            };

            try {
                const method = editingQuizId ? 'PUT' : 'POST';
                const url = editingQuizId
                    ? `${API_URL}/api/quizzes/${editingQuizId}`
                    : `${API_URL}/api/quizzes`;

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(quizData)
                });

                const data = await response.json();

                if (data.success) {
                    showMessage(editingQuizId ? 'Quiz updated successfully!' : 'Quiz created successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = '/quizzes.html';
                    }, 1500);
                } else {
                    showMessage(data.message || 'Failed to save quiz', 'error');
                }
            } catch (error) {
                showMessage('Network error. Please try again.', 'error');
                console.error('Error saving quiz:', error);
            }
        }

        function cancelQuiz() {
            if (confirm('Are you sure? Any unsaved changes will be lost.')) {
                window.location.href = '/quizzes.html';
            }
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }
        }
    </script>
</body>
</html>
