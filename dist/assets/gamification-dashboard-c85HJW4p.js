import{t as f}from"./toast-93yYkT8V.js";/* empty css               */import{c as b,g}from"./api-Dxj3jBlT.js";import{l as d}from"./logger-gSLuc3Ra.js";let p=null,m=null,l=[],u="points",h="week";d.debug("üîµ Gamification Dashboard Loaded - Version 1.0.0-modular");document.addEventListener("DOMContentLoaded",async()=>{await C(),await B(),await y(),setInterval(()=>{y(!0)},3e4)});async function C(){const n=localStorage.getItem("token");if(!n){window.location.href="login.html";return}const t=JSON.parse(atob(n.split(".")[1]));p=t.userId||t.id}async function B(){try{const t=(await b.getAll()).classes||[],o=document.getElementById("classSelector");t.forEach(e=>{const i=document.createElement("option");i.value=e._id||e.id,i.textContent=e.name,o.appendChild(i)})}catch(n){d.error("Error loading classes:",n),f.error("Failed to load classes")}}async function y(n=!1){try{n||(document.getElementById("refreshIndicator").style.display="inline-flex"),m=document.getElementById("classSelector").value||null,d.debug("üîç Loading dashboard data:",{currentClassId:m,currentInstructorId:p,isAllClasses:!m});let t=[];if(m){const o=await g.getLeaderboard(m);d.debug("üìä Leaderboard response:",o),l=o.leaderboard||[],d.debug("üë• Leaderboard data:",l.length,"students")}else{const e=(await b.getAll()).classes||[];d.debug("üìö Fetching leaderboards for",e.length,"classes");for(const s of e)try{const a=await g.getLeaderboard(s._id||s.id);a.leaderboard&&a.leaderboard.length>0&&t.push(...a.leaderboard)}catch(a){d.warn(`Failed to load leaderboard for class ${s.name}:`,a)}const i=new Map;t.forEach(s=>{const a=i.get(s.studentId);a?(a.totalPoints=(a.totalPoints||0)+(s.totalPoints||0),a.level=Math.max(a.level||1,s.level||1),a.achievementCount=(a.achievementCount||0)+(s.achievementCount||0)):i.set(s.studentId,{...s})}),l=Array.from(i.values()),d.debug("üë• Combined leaderboard data:",l.length,"students")}x(),w(),await S(),await E(),await k(),document.getElementById("refreshIndicator").style.display="none"}catch(t){d.error("‚ùå Error loading dashboard data:",t),document.getElementById("refreshIndicator").style.display="none",n||f.error("Failed to load dashboard data")}}function x(n){const t=l.length;document.getElementById("totalStudents").textContent=t;const o=l.reduce((s,a)=>s+(a.points||0),0);document.getElementById("totalPoints").textContent=o.toLocaleString();const e=l.reduce((s,a)=>s+(a.achievementCount||0),0);document.getElementById("totalAchievements").textContent=e;const i=l.length>0?85:0;document.getElementById("avgParticipation").textContent=i+"%",document.getElementById("studentsChange").textContent=`+${Math.floor(t*.1)} this week`,document.getElementById("pointsChange").textContent=`+${Math.floor(o*.15).toLocaleString()} this week`,document.getElementById("achievementsChange").textContent=`+${Math.floor(e*.2)} this week`,document.getElementById("participationChange").textContent="+5% this week"}function w(){const n=document.getElementById("leaderboardList"),t=document.getElementById("emptyLeaderboard");if(l.length===0){n.style.display="none",t.style.display="block";return}n.style.display="flex",t.style.display="none";let o=[...l];u==="points"?o.sort((e,i)=>(i.points||0)-(e.points||0)):u==="level"?o.sort((e,i)=>(i.level||0)-(e.level||0)):u==="achievements"&&o.sort((e,i)=>(i.achievementCount||0)-(e.achievementCount||0)),n.innerHTML=o.map((e,i)=>{const s=i+1;let a="";s===1?a="gold":s===2?a="silver":s===3&&(a="bronze");const r=e.studentName?e.studentName.split(" ").map(c=>c[0]).join("").toUpperCase():"?",v=u==="points"?(e.points||0).toLocaleString():u==="level"?`Level ${e.level||1}`:`${e.achievementCount||0} achievements`;return`
                    <div class="leaderboard-item" onclick="viewStudentDetails('${e.studentId}')">
                        <div class="rank ${a}">${s}</div>
                        <div class="student-avatar">${r}</div>
                        <div class="student-info">
                            <div class="student-name">${e.studentName||"Student"}</div>
                            <div class="student-meta">${e.points||0} points ‚Ä¢ ${e.achievementCount||0} achievements</div>
                        </div>
                        <div class="student-points">
                            <div class="points-value">${v}</div>
                            <div class="level-badge">Level ${e.level||1}</div>
                        </div>
                    </div>
                `}).join("")}function $(n){u=n,document.querySelectorAll(".leaderboard-card .filter-tabs .filter-tab").forEach(t=>{t.classList.remove("active")}),event.target.classList.add("active"),w()}async function S(){try{const n=[],t=document.getElementById("recentAchievementsList"),o=document.getElementById("emptyAchievements");if(n.length===0){t.style.display="none",o.style.display="block";return}t.style.display="block",o.style.display="none",t.innerHTML=n.map(e=>{const i=I(new Date(e.unlockedAt));return`
                        <div class="achievement-item">
                            <div class="achievement-icon" style="background: ${e.color||"#667eea"};">
                                ${e.icon||"üèÖ"}
                            </div>
                            <div class="achievement-details">
                                <div class="achievement-title">${e.name}</div>
                                <div class="achievement-student">${e.studentName||"Student"}</div>
                                <div class="achievement-time">${i}</div>
                            </div>
                        </div>
                    `}).join("")}catch(n){d.error("Error loading recent achievements:",n),document.getElementById("emptyAchievements").style.display="block"}}async function E(){const n=document.getElementById("engagementChart"),e=h==="week"?[65,72,68,80,75,82,78]:[70,75,72,78,80,85,82,88,84,90,87,92,89,95,91,88,85,90,92,95,93,97,94,98,96,99,97,100,98,95],i=h==="week"?["Mon","Tue","Wed","Thu","Fri","Sat","Sun"]:Array.from({length:30},(a,r)=>(r+1).toString()),s=Math.max(...e);n.innerHTML=e.map((a,r)=>`
                    <div class="chart-bar" style="height: ${a/s*100}%;">
                        <div class="chart-bar-value">${a}</div>
                        <div class="chart-bar-label">${i[r]}</div>
                    </div>
                `).join("")}function M(n){h=n,document.querySelectorAll(".chart-card .filter-tabs .filter-tab").forEach(o=>o.classList.remove("active")),event.target.classList.add("active"),E()}async function k(){const n=document.getElementById("achievementDistribution"),t={"First Answer":{icon:"üéØ",count:0},"Perfect Score":{icon:"üíØ",count:0},"Speed Demon":{icon:"‚ö°",count:0},Consistent:{icon:"üî•",count:0},"Team Player":{icon:"ü§ù",count:0},"Knowledge Master":{icon:"üß†",count:0}};l.forEach(o=>{o.achievements&&o.achievements.forEach(e=>{t[e.name]&&t[e.name].count++})}),n.innerHTML=Object.entries(t).map(([o,e])=>`
                <div class="distribution-item">
                    <div class="distribution-icon">${e.icon}</div>
                    <div class="distribution-count">${e.count}</div>
                    <div class="distribution-label">${o}</div>
                </div>
            `).join("")}async function A(n){var t;try{const e=(await g.getStudentStats(m||p,n)).player;document.getElementById("modalStudentName").textContent=e.name||"Student",document.getElementById("modalPoints").textContent=(e.totalPoints||0).toLocaleString(),document.getElementById("modalLevel").textContent=e.level||1,document.getElementById("modalAchievements").textContent=((t=e.achievements)==null?void 0:t.length)||0,document.getElementById("modalParticipation").textContent=(e.participationRate||0)+"%";const i=e.experiencePoints||0,s=e.nextLevelXP||100,a=i/s*100;document.getElementById("modalLevelProgress").style.width=a+"%",document.getElementById("modalCurrentXP").textContent=i+" XP",document.getElementById("modalNextLevelXP").textContent=s+" XP";const r=document.getElementById("modalAchievementList");e.achievements&&e.achievements.length>0?r.innerHTML=e.achievements.map(c=>`
                        <div class="achievement-showcase-item">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">${c.icon||"üèÖ"}</div>
                            <div style="font-size: 0.75rem; font-weight: 600;">${c.name}</div>
                        </div>
                    `).join(""):r.innerHTML='<p style="text-align: center; color: var(--text-secondary);">No achievements yet</p>';const v=document.getElementById("modalActivityList");e.recentActivity&&e.recentActivity.length>0?v.innerHTML=e.recentActivity.map(c=>`
                        <div style="padding: 1rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 0.75rem;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">${c.description}</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">${I(new Date(c.timestamp))}</div>
                        </div>
                    `).join(""):v.innerHTML='<p style="text-align: center; color: var(--text-secondary);">No recent activity</p>',document.getElementById("studentModal").classList.add("active")}catch(o){d.error("Error loading student details:",o),f.error("Failed to load student details")}}function L(){document.getElementById("studentModal").classList.remove("active")}function I(n){const t=Math.floor((new Date-n)/1e3);return t<60?"just now":t<3600?Math.floor(t/60)+" minutes ago":t<86400?Math.floor(t/3600)+" hours ago":t<604800?Math.floor(t/86400)+" days ago":Math.floor(t/604800)+" weeks ago"}document.getElementById("studentModal").addEventListener("click",n=>{n.target.id==="studentModal"&&L()});window.loadDashboardData=y;window.filterLeaderboard=$;window.changeChartPeriod=M;window.viewStudentDetails=A;window.closeStudentModal=L;
