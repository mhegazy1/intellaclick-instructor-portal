import"./toast-93yYkT8V.js";import{l}from"./logger-gSLuc3Ra.js";import{l as c}from"./loading-CWfhFw7n.js";let i,d,s=[],u={field:"name"};document.addEventListener("DOMContentLoaded",function(){if(i=new URLSearchParams(window.location.search).get("classId"),!i){window.location.href="classes.html";return}p(),y(),w()});function p(){var a;const t=localStorage.getItem("token"),n=JSON.parse(localStorage.getItem("user")||"{}");(!t||!["instructor","admin","teacher","professor","faculty","teaching_assistant"].includes((a=n.role)==null?void 0:a.toLowerCase()))&&(window.location.href="login.html")}async function y(){var t;c.show("Loading class information...");try{const n=await fetch(`https://api-modular.intellaclick.com/api/classes/${i}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!n.ok)throw new Error("Failed to load class data");d=(await n.json()).class,l.info("Class data loaded:",d),document.getElementById("className").textContent=`${d.name} - Analytics`,document.getElementById("classCode").textContent=`${d.code}${d.section?" - "+d.section:""}`,document.getElementById("classTerm").textContent=d.term,document.getElementById("studentCount").textContent=((t=d.enrollmentSummary)==null?void 0:t.enrolled)||0}catch(n){l.error("Failed to load class data",n)}finally{c.hide()}}async function w(){document.getElementById("periodFilter").value,c.show("Loading analytics data...");try{const t=localStorage.getItem("token");if(!t){window.location.href="login.html";return}const n=await fetch(`https://api-modular.intellaclick.com/api/classes/${i}/students`,{headers:{Authorization:`Bearer ${t}`}});if(!n.ok)throw new Error("Failed to load student data");const e=await n.json();l.info("Analytics API response:",e),e.students&&e.students.length>0?(l.info("Found students:",e.students.length),s=e.students.filter(a=>a.status==="enrolled").map(a=>{const o=a.stats||{},r=o.questionsAnswered||0,m=o.correctAnswers||0,h=r>0?Math.round(m/r*100):0;return{id:a.studentId,name:`${a.firstName} ${a.lastName}`,email:a.email,attendance:o.attendanceRate||0,performance:h,engagement:o.attendanceRate||0,questionsAnswered:r,correctAnswers:m,sessionsAttended:o.sessionsAttended||0,lastActive:o.lastAttendanceDate?new Date(o.lastAttendanceDate):new Date(a.enrolledAt)}}),l.info("Transformed analytics data:",s)):(l.info("No students found in response"),s=[]),g(),f()}catch(t){l.error("Failed to load analytics data",t),s=[],g(),f()}finally{c.hide()}}function g(){if(s.length===0){document.getElementById("avgAttendance").textContent="0%",document.getElementById("avgPerformance").textContent="0%",document.getElementById("totalSessions").textContent="0",document.getElementById("engagementRate").textContent="0%";return}const t=Math.round(s.reduce((o,r)=>o+r.attendance,0)/s.length),n=Math.round(s.reduce((o,r)=>o+r.performance,0)/s.length),e=Math.round(s.reduce((o,r)=>o+r.engagement,0)/s.length),a=s.length>0?Math.max(...s.map(o=>o.sessionsAttended||0)):0;document.getElementById("avgAttendance").textContent=`${t||0}%`,document.getElementById("avgPerformance").textContent=`${n||0}%`,document.getElementById("totalSessions").textContent=a,document.getElementById("engagementRate").textContent=`${e||0}%`}function f(){const t=document.getElementById("studentTableBody");if(s.length===0){t.innerHTML='<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-secondary);">No students enrolled yet</td></tr>';return}const n=[...s].sort((e,a)=>{let o=e[u.field],r=a[u.field];return o>r?1:-1});t.innerHTML=n.map(e=>{const a=e.performance>=80?"high":e.performance>=60?"medium":"low";return`
                    <tr onclick="showStudentDetail('${e.id||e.studentId||e.email}', '${e.name.replace(/'/g,"\\'")}')">
                        <td class="student-name">${e.name}</td>
                        <td>
                            <div class="performance-bar">
                                <div class="progress-bar">
                                    <div class="progress-fill ${a}"
                                         style="width: ${e.attendance}%"></div>
                                </div>
                                <span>${e.attendance}%</span>
                            </div>
                        </td>
                        <td>
                            <div class="performance-bar">
                                <div class="progress-bar">
                                    <div class="progress-fill ${a}"
                                         style="width: ${e.performance}%"></div>
                                </div>
                                <span>${e.performance}%</span>
                            </div>
                        </td>
                        <td>${e.engagement}%</td>
                        <td>${v(e.lastActive)}</td>
                    </tr>
                `}).join("")}function v(t){const n=Math.floor((Date.now()-t)/864e5);return n===0?"Today":n===1?"Yesterday":n<7?`${n} days ago`:t.toLocaleDateString()}
