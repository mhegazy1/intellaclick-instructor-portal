import{t as E}from"./toast-OawwZGYy.js";/* empty css               */import{c as w,g as p}from"./api-Cc5qfUA_.js";import{l}from"./logger-P_9I2l6U.js";let y=null,m=null,d=[],h="points",f="week";l.debug("üîµ Gamification Dashboard Loaded - Version 1.0.0-modular");document.addEventListener("DOMContentLoaded",async()=>{await $(),await D(),await b(),setInterval(()=>{b(!0)},3e4)});async function $(){const i=localStorage.getItem("token");if(!i){window.location.href="login.html";return}const t=JSON.parse(atob(i.split(".")[1]));y=t.userId||t.id}async function D(){try{const t=(await w.getAll()).classes||[],s=document.getElementById("classSelector");t.forEach(a=>{const e=document.createElement("option");e.value=a._id||a.id,e.textContent=a.name,s.appendChild(e)})}catch(i){l.error("Error loading classes:",i),E.error("Failed to load classes")}}async function b(i=!1){try{i||(document.getElementById("refreshIndicator").style.display="inline-flex"),m=document.getElementById("classSelector").value||null,l.debug("üîç Loading dashboard data:",{currentClassId:m,currentInstructorId:y,isAllClasses:!m});let t=[];if(m){const s=await p.getLeaderboard(m);l.debug("üìä Leaderboard response:",s),d=s.leaderboard||[],l.debug("üë• Leaderboard data:",d.length,"students")}else{const a=(await w.getAll()).classes||[];l.debug("üìö Fetching leaderboards for",a.length,"classes");for(const o of a)try{const n=await p.getLeaderboard(o._id||o.id);n.leaderboard&&n.leaderboard.length>0&&t.push(...n.leaderboard)}catch(n){l.warn(`Failed to load leaderboard for class ${o.name}:`,n)}const e=new Map;t.forEach(o=>{const n=e.get(o.studentId);n?(n.totalPoints=(n.totalPoints||0)+(o.totalPoints||0),n.level=Math.max(n.level||1,o.level||1),n.achievementCount=(n.achievementCount||0)+(o.achievementCount||0)):e.set(o.studentId,{...o})}),d=Array.from(e.values()),l.debug("üë• Combined leaderboard data:",d.length,"students")}x(),S(),await M(),await I(),await k(),document.getElementById("refreshIndicator").style.display="none"}catch(t){l.error("‚ùå Error loading dashboard data:",t),document.getElementById("refreshIndicator").style.display="none",i||E.error("Failed to load dashboard data")}}function x(i){const t=d.length;document.getElementById("totalStudents").textContent=t;const s=d.reduce((o,n)=>o+(n.totalPoints||n.points||0),0);document.getElementById("totalPoints").textContent=s.toLocaleString(),console.log("üîç DEBUG - Leaderboard data for achievement count:",d.map(o=>({name:o.name||o.studentName,achievementCount:o.achievementCount,questionsAnswered:o.questionsAnswered,bestStreak:o.bestStreak,points:o.totalPoints||o.points})));const a=d.reduce((o,n)=>(console.log(`üîç DEBUG - Student ${n.name||n.studentName}: ${n.achievementCount||0} achievements`),o+(n.achievementCount||0)),0);console.log(`üîç DEBUG - Total achievements: ${a}`),document.getElementById("totalAchievements").textContent=a;const e=d.length>0?Math.round(d.reduce((o,n)=>o+(n.accuracy||0),0)/d.length):0;document.getElementById("avgParticipation").textContent=e+"%",document.getElementById("studentsChange").textContent=`+${Math.floor(t*.1)} this week`,document.getElementById("pointsChange").textContent=`+${Math.floor(s*.15).toLocaleString()} this week`,document.getElementById("achievementsChange").textContent=`+${Math.floor(a*.2)} this week`,document.getElementById("participationChange").textContent="+5% this week"}function S(){const i=document.getElementById("leaderboardList"),t=document.getElementById("emptyLeaderboard");if(d.length===0){i.style.display="none",t.style.display="block";return}i.style.display="flex",t.style.display="none";let s=[...d];h==="points"?s.sort((a,e)=>(e.totalPoints||e.points||0)-(a.totalPoints||a.points||0)):h==="level"?s.sort((a,e)=>(e.level||0)-(a.level||0)):h==="achievements"&&s.sort((a,e)=>(e.achievementCount||0)-(a.achievementCount||0)),i.innerHTML=s.map((a,e)=>{const o=e+1;let n="";o===1?n="gold":o===2?n="silver":o===3&&(n="bronze");const u=a.name||a.studentName||"Student",c=a.playerId||a.studentId,g=a.totalPoints||a.points||0,r=u.split(" ").map(B=>B[0]).join("").toUpperCase(),v=h==="points"?g.toLocaleString():h==="level"?`Level ${a.level||1}`:`${a.achievementCount||0} achievements`;return`
                    <div class="leaderboard-item" onclick="viewStudentDetails('${c}')">
                        <div class="rank ${n}">${o}</div>
                        <div class="student-avatar">${r}</div>
                        <div class="student-info">
                            <div class="student-name">${u}</div>
                            <div class="student-meta">${g} points ‚Ä¢ ${a.achievementCount||0} achievements</div>
                        </div>
                        <div class="student-points">
                            <div class="points-value">${v}</div>
                            <div class="level-badge">Level ${a.level||1}</div>
                        </div>
                    </div>
                `}).join("")}function P(i){h=i,document.querySelectorAll(".leaderboard-card .filter-tabs .filter-tab").forEach(t=>{t.classList.remove("active")}),event.target.classList.add("active"),S()}async function M(){try{l.debug("üèÜ Loading recent achievements for classId:",m);const t=(await p.getRecentAchievements(m,10)).achievements||[];l.debug("üèÜ Received achievements:",t.length);const s=document.getElementById("recentAchievementsList"),a=document.getElementById("emptyAchievements");if(t.length===0){s.style.display="none",a.style.display="block";return}s.style.display="block",a.style.display="none",s.innerHTML=t.map(e=>{const o=C(new Date(e.unlockedAt));return`
                        <div class="achievement-item">
                            <div class="achievement-icon" style="background: ${e.color||"#667eea"};">
                                ${e.icon||"üèÖ"}
                            </div>
                            <div class="achievement-details">
                                <div class="achievement-title">${e.name}</div>
                                <div class="achievement-student">${e.studentName||"Student"}</div>
                                <div class="achievement-time">${o}</div>
                            </div>
                        </div>
                    `}).join("")}catch(i){l.error("Error loading recent achievements:",i),document.getElementById("emptyAchievements").style.display="block"}}async function I(){try{const i=document.getElementById("engagementChart");l.debug("üìä Loading engagement chart for classId:",m,"period:",f);let t=[];if(m)t=(await p.getEngagement(m,f)).engagement||[];else{const u=(await w.getAll()).classes||[];l.debug("üìä Fetching engagement for",u.length,"classes");const c={};for(const g of u)try{const r=await p.getEngagement(g._id||g.id,f);r.engagement&&r.engagement.forEach(v=>{c[v.date]||(c[v.date]=new Set),c[v.date]=(c[v.date]instanceof Set?0:c[v.date])+v.activeStudents})}catch(r){l.warn(`Failed to load engagement for class ${g.name}:`,r)}t=Object.keys(c).sort().map(g=>({date:g,activeStudents:c[g]}))}l.debug("üìä Engagement data:",t);const s=t.map(n=>n.activeStudents),a=t.map(n=>new Date(n.date)),e=f==="week"?a.map(n=>["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][n.getDay()]):a.map(n=>n.getDate().toString()),o=Math.max(...s,1);i.innerHTML=s.map((n,u)=>{const c=o>0?n/o*100:0;return`
                        <div class="chart-bar" style="height: ${Math.max(c,5)}%;">
                            <div class="chart-bar-value">${n}</div>
                            <div class="chart-bar-label">${e[u]}</div>
                        </div>
                    `}).join("")}catch(i){l.error("Error loading engagement chart:",i)}}function A(i){f=i,document.querySelectorAll(".chart-card .filter-tabs .filter-tab").forEach(s=>s.classList.remove("active")),event.target.classList.add("active"),I()}async function k(){const i=document.getElementById("achievementDistribution"),t={"First Steps":{icon:"üéØ",count:0,description:"Completed first session"},"Perfect Score":{icon:"üíØ",count:0,description:"Earned 100+ points"},"Speed Demon":{icon:"‚ö°",count:0,description:"Fast responses"},Consistent:{icon:"üî•",count:0,description:"3+ correct streak"},"Team Player":{icon:"ü§ù",count:0,description:"50+ questions answered"},"Knowledge Master":{icon:"üß†",count:0,description:"Reached level 10+"}};d.forEach(s=>{const a=s.totalPoints||0,e=s.level||1,o=s.questionsAnswered||0,n=s.bestStreak||0;(a>0||o>0)&&t["First Steps"].count++,a>=100&&t["Perfect Score"].count++,o>=20&&t["Speed Demon"].count++,n>=3&&t.Consistent.count++,o>=50&&t["Team Player"].count++,e>=10&&t["Knowledge Master"].count++}),i.innerHTML=Object.entries(t).map(([s,a])=>`
                <div class="distribution-item" title="${a.description}">
                    <div class="distribution-icon">${a.icon}</div>
                    <div class="distribution-count">${a.count}</div>
                    <div class="distribution-label">${s}</div>
                </div>
            `).join("")}async function N(i){var t;try{console.log("üîç DEBUG - viewStudentDetails called with playerId:",i),console.log("üîç DEBUG - currentClassId:",m),console.log("üîç DEBUG - currentInstructorId:",y),console.log("üîç DEBUG - leaderboardData:",d);const s=d.find(r=>r.playerId===i||r.studentId===i);console.log("üîç DEBUG - Student found in leaderboard:",JSON.parse(JSON.stringify(s))),l.debug("Loading student details:",{playerId:i,classId:m,instructorId:y});const a=await p.getStudentStats(m||y,i);console.log("üîç DEBUG - API response data:",JSON.parse(JSON.stringify(a))),l.debug("Student stats response:",a);const e=a.player;console.log("üîç DEBUG - Extracted player object:",JSON.parse(JSON.stringify(e))),console.log("üîç DEBUG - Setting modal values:"),console.log("  - Name:",e.name||"Student"),console.log("  - Total Points:",e.totalPoints),console.log("  - Level:",e.level),console.log("  - Achievements:",e.achievements),console.log("  - Experience Points:",e.experiencePoints),console.log("  - Participation Rate:",e.participationRate),document.getElementById("modalStudentName").textContent=e.name||"Student",document.getElementById("modalPoints").textContent=(e.totalPoints||0).toLocaleString(),document.getElementById("modalLevel").textContent=e.level||1,document.getElementById("modalAchievements").textContent=((t=e.achievements)==null?void 0:t.length)||0,document.getElementById("modalParticipation").textContent=(e.participationRate||0)+"%";const o=e.experiencePoints||0,n=e.nextLevelXP||100,u=o/n*100;console.log("üîç DEBUG - Level progress:",JSON.parse(JSON.stringify({currentXP:o,nextLevelXP:n,progress:u}))),document.getElementById("modalLevelProgress").style.width=u+"%",document.getElementById("modalCurrentXP").textContent=o+" XP",document.getElementById("modalNextLevelXP").textContent=n+" XP";const c=document.getElementById("modalAchievementList");e.achievements&&e.achievements.length>0?c.innerHTML=e.achievements.map(r=>`
                        <div class="achievement-showcase-item" title="${r.description||""}" style="cursor: help;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">${r.icon||"üèÖ"}</div>
                            <div style="font-size: 0.75rem; font-weight: 600;">${r.name}</div>
                            <div style="font-size: 0.65rem; color: var(--text-secondary); margin-top: 0.25rem;">${r.description||""}</div>
                        </div>
                    `).join(""):c.innerHTML='<p style="text-align: center; color: var(--text-secondary);">No achievements yet</p>';const g=document.getElementById("modalActivityList");e.recentActivity&&e.recentActivity.length>0?g.innerHTML=e.recentActivity.map(r=>`
                        <div style="padding: 1rem; background: ${r.type==="correct_answer"?"#e8f5e9":"#f8f9fa"}; border-radius: 8px; margin-bottom: 0.75rem; border-left: 3px solid ${r.type==="correct_answer"?"#4caf50":"#ddd"};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.25rem;">
                                <div style="font-weight: 600; flex: 1;">${r.description}</div>
                                ${r.points>0?`<div style="color: #4caf50; font-weight: 600; margin-left: 1rem;">+${r.points}</div>`:""}
                            </div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">${C(new Date(r.timestamp))}</div>
                        </div>
                    `).join(""):g.innerHTML='<p style="text-align: center; color: var(--text-secondary);">No recent activity</p>',document.getElementById("studentModal").classList.add("active")}catch(s){console.error("üîç DEBUG - Error in viewStudentDetails:",s),l.error("Error loading student details:",s),l.error("Error details:",{message:s.message,stack:s.stack}),E.error(`Failed to load student details: ${s.message}`)}}function L(){document.getElementById("studentModal").classList.remove("active")}function C(i){const t=Math.floor((new Date-i)/1e3);return t<60?"just now":t<3600?Math.floor(t/60)+" minutes ago":t<86400?Math.floor(t/3600)+" hours ago":t<604800?Math.floor(t/86400)+" days ago":Math.floor(t/604800)+" weeks ago"}document.getElementById("studentModal").addEventListener("click",i=>{i.target.id==="studentModal"&&L()});window.loadDashboardData=b;window.filterLeaderboard=P;window.changeChartPeriod=A;window.viewStudentDetails=N;window.closeStudentModal=L;
