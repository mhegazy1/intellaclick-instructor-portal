import{t as r}from"./toast-93yYkT8V.js";/* empty css               *//* empty css                       */import{c as v,s as S}from"./api-BBvzFwfC.js";import{l as s}from"./logger-gSLuc3Ra.js";let I,m,y=null,u=[];document.addEventListener("DOMContentLoaded",function(){if(I=new URLSearchParams(window.location.search).get("classId"),!I){window.location.href="classes.html";return}B(),A(),document.getElementById("sessionForm").addEventListener("submit",x),q();const n=sessionStorage.getItem("fromSavedSet"),o=sessionStorage.getItem("pendingQuestions");s.debug("üîµ Page loaded - checking for pending questions"),s.debug("fromSavedSet:",n),s.debug("pendingQuestions:",o?"exists":"none"),n==="true"&&o&&(s.debug("‚úÖ Auto-selecting Quick Poll mode"),setTimeout(()=>{E("quick")},500))});function B(){localStorage.getItem("token")||(window.location.href="login.html")}async function q(){try{const e=await fetch("https://api.intellaclick.com/api/users/session-settings",{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(e.ok){const o=(await e.json()).settings;o.allowAnonymous!==void 0&&(document.getElementById("allowAnonymous").checked=o.allowAnonymous),o.openToAll!==void 0&&(document.getElementById("openToAll").checked=o.openToAll),o.allowAnswerChange!==void 0&&(document.getElementById("allowAnswerChange").checked=o.allowAnswerChange),o.showCorrectAnswer!==void 0&&(document.getElementById("showCorrectAnswer").checked=o.showCorrectAnswer),o.enableGamification!==void 0&&(document.getElementById("enableGamification").checked=o.enableGamification),s.debug("‚úÖ Loaded saved session settings from backend:",o)}else s.debug("No saved settings found, using defaults")}catch(e){s.error("Error loading saved settings:",e)}}async function A(){try{const e=await v.getById(I);m=e.class||e,document.getElementById("classInfo").innerHTML=`
                    <strong>${m.name}</strong> - ${m.code} ${m.section?"("+m.section+")":""}
                `;const n=new Date,o=n.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),t=n.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"});document.getElementById("sessionName").value=`${m.name} Session - ${o} ${t}`}catch(e){s.error("Error loading class:",e),r.error("Failed to load class information")}}function E(e){if(s.debug("=== selectSessionType called ==="),s.debug("type:",e),y=e,e!=="quick")u=[];else{const t=sessionStorage.getItem("fromSavedSet"),i=sessionStorage.getItem("pendingQuestions");if(s.debug("fromSavedSet:",t),s.debug("pendingQuestions:",i?`${i.length} chars`:"null"),t==="true"&&i)try{u=JSON.parse(i),s.debug("‚úÖ Loaded questions:",u.length),sessionStorage.removeItem("fromSavedSet"),sessionStorage.removeItem("pendingQuestions"),r.success(`Loaded ${u.length} questions from saved set`)}catch(a){s.error("‚ùå Error loading saved questions:",a)}else s.debug("No pending questions found");b()}document.querySelectorAll(".option-card").forEach(t=>{t.classList.remove("selected")}),document.getElementById(e+"Option").classList.add("selected"),document.getElementById("sessionConfig").style.display="block",document.getElementById("quickPollConfig").style.display=e==="quick"?"block":"none",document.getElementById("quizConfig").style.display=e==="quiz"?"block":"none",document.getElementById("desktopInstructions").style.display=e==="desktop"?"block":"none";const n=e!=="desktop";document.getElementById("sessionSettings").style.display=n?"block":"none",document.getElementById("sessionOptions").style.display=n?"block":"none",document.getElementById("sessionName").parentElement.style.display=n?"block":"none",document.getElementById("startButton").style.display=e==="desktop"?"none":"inline-block",e==="quiz"?T():e==="desktop"&&z();const o=new Date;document.getElementById("sessionName").value=`${m.name} - ${o.toLocaleDateString()}`}async function T(){try{const n=await(await fetch("https://api.intellaclick.com/api/quizzes",{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}})).json(),o=document.getElementById("quizSelect"),t=document.getElementById("noQuizzesMessage");n.success&&n.quizzes&&n.quizzes.length>0?(o.innerHTML='<option value="">Select a quiz...</option>'+n.quizzes.map(i=>`<option value="${i._id}">${i.title} (${i.questionCount||0} questions)</option>`).join(""),t.style.display="none"):(o.innerHTML='<option value="">No quizzes available</option>',t.style.display="block")}catch(e){s.error("Error loading quizzes:",e);const n=document.getElementById("quizSelect");n.innerHTML='<option value="">Error loading quizzes</option>',r.error("Failed to load quizzes")}}function z(){document.getElementById("desktopClassName").textContent=m.name,document.getElementById("desktopJoinCode").textContent=m.joinCode||"N/A"}function C(){const e=document.getElementById("questionType").value;switch(document.getElementById("mcqOptions").style.display="none",document.getElementById("pollOptions").style.display="none",document.getElementById("tfOptions").style.display="none",document.getElementById("matchingOptions").style.display="none",document.getElementById("orderingOptions").style.display="none",document.getElementById("fillblankOptions").style.display="none",e){case"mcq":document.getElementById("mcqOptions").style.display="block";break;case"poll":document.getElementById("pollOptions").style.display="block";break;case"tf":document.getElementById("tfOptions").style.display="block";break;case"matching":document.getElementById("matchingOptions").style.display="block";break;case"ordering":document.getElementById("orderingOptions").style.display="block";break;case"fillblank":document.getElementById("fillblankOptions").style.display="block";break}}function $(){const e=document.getElementById("questionType").value,n=document.getElementById("questionText").value.trim();if(!n){r.error("Please enter a question");return}const o=parseInt(document.getElementById("duration").value)||60;let t={text:n,type:e,timeLimit:o,points:10};try{switch(e){case"mcq":const i=[],a=[];let g=null;if(["A","B","C","D"].forEach(l=>{const c=document.getElementById(`option${l}`);if(c&&c.value.trim()){i.push(l),a.push(c.value.trim());const h=document.querySelector(`input[name="correctAnswer"][value="${l}"]`);h&&h.checked&&(g=l)}}),i.length<2){r.error("Please provide at least 2 answer options");return}t.options=i,t.optionTexts=a,t.correctAnswer=g;break;case"poll":const p=[],w=[];if(["A","B","C","D"].forEach(l=>{const c=document.getElementById(`pollOption${l}`);c&&c.value.trim()&&(p.push(l),w.push(c.value.trim()))}),p.length<2){r.error("Please provide at least 2 poll options");return}t.options=p,t.optionTexts=w;break;case"tf":t.options=["True","False"],t.correctAnswer=document.querySelector('input[name="tfAnswer"]:checked').value;break;case"matching":const f=[];for(let l=1;l<=4;l++){const c=document.getElementById(`match${l}Left`).value.trim(),h=document.getElementById(`match${l}Right`).value.trim();c&&h&&f.push({left:c,right:h})}if(f.length<2){r.error("Please provide at least 2 matching pairs");return}t.pairs=f;break;case"ordering":const d=[];for(let l=1;l<=4;l++){const c=document.getElementById(`order${l}`).value.trim();c&&d.push(c)}if(d.length<2){r.error("Please provide at least 2 items to order");return}t.correctOrder=d;break;case"fillblank":const k=document.getElementById("blankAnswer").value.trim();if(!k){r.error("Please provide the correct answer");return}if(!n.includes("[blank]")){r.error("Please include [blank] in your question where the answer should go");return}t.correctAnswer=k;break}u.push(t),Q(),b(),r.success("Question added successfully!")}catch(i){r.error("Error adding question: "+i.message)}}function Q(){document.getElementById("questionText").value="",["A","B","C","D"].forEach(n=>{const o=document.getElementById(`option${n}`);o&&(o.value="");const t=document.getElementById(`pollOption${n}`);t&&(t.value="")});for(let n=1;n<=4;n++){const o=document.getElementById(`match${n}Left`),t=document.getElementById(`match${n}Right`),i=document.getElementById(`order${n}`);o&&(o.value=""),t&&(t.value=""),i&&(i.value="")}const e=document.getElementById("blankAnswer");e&&(e.value="")}function O(e){window.confirm("Remove this question?")&&(u.splice(e,1),b())}function b(){const e=document.getElementById("questionsList");if(u.length===0){e.innerHTML='<p style="color: var(--text-secondary); font-size: 14px;">No questions added yet.</p>';return}e.innerHTML=`
                <div style="margin-bottom: 12px;">
                    <strong>${u.length} Question(s) Added:</strong>
                </div>
                ${u.map((n,o)=>`
                    <div style="background-color: #F9FAFB; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; margin-bottom: 4px;">Q${o+1}: ${n.text}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Type: ${n.type.toUpperCase()}</div>
                        </div>
                        <button type="button" class="btn btn-danger btn-small" onclick="removeQuickPollQuestion(${o})" style="margin-left: 12px;">Remove</button>
                    </div>
                `).join("")}
            `}async function x(e){if(e.preventDefault(),!y){r.error("Please select a session type");return}if(y==="desktop")return;const o=document.getElementById("customSessionCode").value.trim()||Math.random().toString(36).substring(2,8).toUpperCase(),t={sessionCode:o,title:document.getElementById("sessionName").value,description:`${y==="quick"?"Quick Poll":"Quiz Session"} for ${m.name}`,requireLogin:!document.getElementById("allowAnonymous").checked,classId:I,restrictToEnrolled:!document.getElementById("openToAll").checked,gamification:{enabled:document.getElementById("enableGamification").checked},allowAnswerChange:document.getElementById("allowAnswerChange").checked,showCorrectAnswer:document.getElementById("showCorrectAnswer").checked};if(s.debug("=== CREATING SESSION WITH SETTINGS ==="),s.debug("showCorrectAnswer checkbox value:",document.getElementById("showCorrectAnswer").checked),s.debug("Session data being sent:",t),y==="quick"){if(u.length===0){r.error("Please add at least one question to the quick poll");return}t.questions=u}else if(y==="quiz"){const i=document.getElementById("quizSelect").value;if(!i){r.error("Please select a quiz");return}try{const a=await fetch(`https://api.intellaclick.com/api/quizzes/${i}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!a.ok)throw new Error("Failed to load quiz");const g=await a.json(),p=g.quiz||g,w=(p.questions||[]).map(f=>{const d=f.questionSnapshot||{},k=d.questionType||d.type||"mcq";return{text:d.questionText||"",type:k,timeLimit:60,points:f.points||10,options:d.options,correctAnswer:d.correctAnswer,pairs:d.pairs,correctOrder:d.correctOrder,optionTexts:d.options}});if(t.questions=w,t.quizId=i,t.quizTitle=p.title,t.questions.length===0){r.error("Selected quiz has no questions");return}}catch(a){s.error("Error loading quiz:",a),r.error("Failed to load quiz data");return}}try{const i=await S.create(t),a=i.session||i,g={allowAnonymous:document.getElementById("allowAnonymous").checked,openToAll:document.getElementById("openToAll").checked,allowAnswerChange:document.getElementById("allowAnswerChange").checked,showCorrectAnswer:document.getElementById("showCorrectAnswer").checked,enableGamification:document.getElementById("enableGamification").checked};fetch("https://api.intellaclick.com/api/users/session-settings",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify(g)}).then(()=>{s.debug("‚úÖ Saved session settings to backend for next time")}).catch(p=>{s.error("Failed to save settings (non-critical):",p)}),r.success(`Session created! Code: ${a.sessionCode||o}`),t.questions&&t.questions.length>0&&(sessionStorage.setItem("pendingQuestions",JSON.stringify(t.questions)),sessionStorage.setItem("currentQuestionIndex","0")),t.questions&&t.questions.length>0&&D(t.title,t.questions),setTimeout(()=>{s.debug("=== REDIRECTING NOW ==="),window.location.href=`session.html?id=${a.id||a._id}&code=${a.sessionCode||o}&type=${y}`},5e3)}catch(i){s.error("Error creating session:",i),r.error(i.message||"Failed to create session")}}function L(){window.confirm("Are you sure you want to cancel?")&&(window.location.href="classes.html")}function P(){const e=window.location.href;sessionStorage.setItem("createSessionUrl",e),s.debug("Navigating to saved questions, returnUrl:",e),window.location.href=`saved-questions.html?returnUrl=${encodeURIComponent(e)}`}function N(){const e=document.getElementById("questionText"),n=e.selectionStart,o=e.selectionEnd,t=e.value,i=t.substring(0,n)+"[blank]"+t.substring(o);e.value=i,e.selectionStart=e.selectionEnd=n+7,e.focus()}async function D(e,n){if(s.debug("=== AUTO-SAVE CALLED ==="),s.debug("Session name:",e),s.debug("Questions array:",n),s.debug("Questions length:",n==null?void 0:n.length),!n||n.length===0){s.debug("‚ùå No questions to save - skipping auto-save");return}const o=localStorage.getItem("token");if(!o){s.warn("‚ö†Ô∏è No authentication token - skipping auto-save (silent)");return}s.debug(`üîÑ Auto-saving "${e}" with ${n.length} questions to cloud...`);const t={name:e,questions:n,classId:null};s.debug("Payload being sent:",JSON.stringify(t,null,2));try{const i=await fetch("https://api.intellaclick.com/api/question-sets",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify(t)});if(s.debug("Response status:",i.status),!i.ok){const g=await i.json();s.error("‚ùå Cloud API save failed:",g),s.error("Response status:",i.status),s.warn("‚ö†Ô∏è Question set auto-save failed, but session will continue");return}const a=await i.json();s.debug("‚úÖ Question set auto-saved to cloud successfully:",a)}catch(i){s.error("‚ùå Error auto-saving question set:",i),s.error("Error stack:",i.stack),s.warn("‚ö†Ô∏è Question set auto-save failed, but session will continue")}}window.selectSessionType=E;window.goToSavedQuestions=P;window.insertBlank=N;window.updateQuestionOptions=C;window.addQuickPollQuestion=$;window.cancelSession=L;window.removeQuickPollQuestion=O;
