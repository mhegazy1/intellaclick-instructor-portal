<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamification Dashboard - IntellaClick</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .dashboard-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        /* Class Selector */
        .class-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .class-selector select {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            background: white;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.2s;
        }

        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .stat-icon.blue { background: #e3f2fd; color: #1976d2; }
        .stat-icon.green { background: #e8f5e9; color: #388e3c; }
        .stat-icon.orange { background: #fff3e0; color: #f57c00; }
        .stat-icon.purple { background: #f3e5f5; color: #7b1fa2; }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .stat-change {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .stat-change.positive { color: #388e3c; }
        .stat-change.negative { color: #d32f2f; }

        /* Main Content Layout */
        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Leaderboard */
        .leaderboard-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .filter-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .filter-tab {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .filter-tab.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .leaderboard-item:hover {
            background: #e9ecef;
        }

        .rank {
            font-size: 1.25rem;
            font-weight: 700;
            width: 40px;
            text-align: center;
        }

        .rank.gold { color: #ffd700; }
        .rank.silver { color: #c0c0c0; }
        .rank.bronze { color: #cd7f32; }

        .student-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin: 0 1rem;
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .student-meta {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .student-points {
            text-align: right;
        }

        .points-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .level-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.25rem;
        }

        /* Recent Achievements */
        .achievements-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .achievement-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }

        .achievement-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .achievement-details {
            flex: 1;
        }

        .achievement-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .achievement-student {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .achievement-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Engagement Chart */
        .chart-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            height: 300px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 2px solid #dee2e6;
        }

        .chart-bar {
            flex: 1;
            background: linear-gradient(to top, var(--primary-color), #667eea);
            border-radius: 8px 8px 0 0;
            position: relative;
            transition: all 0.3s;
            cursor: pointer;
        }

        .chart-bar:hover {
            opacity: 0.8;
        }

        .chart-bar-label {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .chart-bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Achievement Distribution */
        .distribution-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .distribution-item {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .distribution-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .distribution-count {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }

        .distribution-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Student Detail Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            padding: 2rem;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .student-progress-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .progress-card {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .progress-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .progress-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .progress-bar-container {
            margin-top: 0.5rem;
            height: 8px;
            background: #dee2e6;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary-color);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .achievement-showcase {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .achievement-showcase-item {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .achievement-showcase-item:hover {
            background: #e9ecef;
        }

        .achievement-showcase-item.locked {
            opacity: 0.4;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .refresh-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>üèÜ Gamification Dashboard</h1>
            <div class="header-actions">
                <div class="refresh-indicator" id="refreshIndicator" style="display: none;">
                    <div class="spinner"></div>
                    <span>Refreshing...</span>
                </div>
                <button class="btn btn-secondary" onclick="window.location.href='gamification-settings.html'">
                    ‚öôÔ∏è Settings
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='classes.html'">
                    ‚Üê Back
                </button>
            </div>
        </div>

        <!-- Class Selector -->
        <div class="class-selector">
            <label><strong>Select Class:</strong></label>
            <select id="classSelector" onchange="loadDashboardData()">
                <option value="">All Classes (Instructor-wide)</option>
            </select>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">üë•</div>
                <div class="stat-value" id="totalStudents">0</div>
                <div class="stat-label">Active Students</div>
                <div class="stat-change positive" id="studentsChange">+0 this week</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">‚≠ê</div>
                <div class="stat-value" id="totalPoints">0</div>
                <div class="stat-label">Total Points Earned</div>
                <div class="stat-change positive" id="pointsChange">+0 this week</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon orange">üèÖ</div>
                <div class="stat-value" id="totalAchievements">0</div>
                <div class="stat-label">Achievements Unlocked</div>
                <div class="stat-change positive" id="achievementsChange">+0 this week</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon purple">üìä</div>
                <div class="stat-value" id="avgParticipation">0%</div>
                <div class="stat-label">Avg. Participation Rate</div>
                <div class="stat-change positive" id="participationChange">+0% this week</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="content-grid">
            <!-- Leaderboard -->
            <div class="leaderboard-card">
                <div class="card-header">
                    <h2 class="card-title">üèÜ Leaderboard</h2>
                    <div class="filter-tabs">
                        <button class="filter-tab active" onclick="filterLeaderboard('points')">Points</button>
                        <button class="filter-tab" onclick="filterLeaderboard('level')">Level</button>
                        <button class="filter-tab" onclick="filterLeaderboard('achievements')">Achievements</button>
                    </div>
                </div>
                <div class="leaderboard-list" id="leaderboardList">
                    <!-- Leaderboard items will be loaded here -->
                </div>
                <div id="emptyLeaderboard" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">üèÜ</div>
                    <p>No students have earned points yet</p>
                    <p style="font-size: 0.875rem;">Points will appear here after you run sessions with gamification enabled</p>
                </div>
            </div>

            <!-- Recent Achievements -->
            <div class="achievements-card">
                <div class="card-header">
                    <h2 class="card-title">üéâ Recent Achievements</h2>
                </div>
                <div id="recentAchievementsList">
                    <!-- Achievement items will be loaded here -->
                </div>
                <div id="emptyAchievements" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">üéâ</div>
                    <p>No achievements unlocked yet</p>
                </div>
            </div>
        </div>

        <!-- Engagement Chart -->
        <div class="chart-card">
            <div class="card-header">
                <h2 class="card-title">üìà Weekly Engagement</h2>
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="changeChartPeriod('week')">Week</button>
                    <button class="filter-tab" onclick="changeChartPeriod('month')">Month</button>
                </div>
            </div>
            <div class="chart-container" id="engagementChart">
                <!-- Chart bars will be generated here -->
            </div>
        </div>

        <!-- Achievement Distribution -->
        <div class="chart-card">
            <div class="card-header">
                <h2 class="card-title">üèÖ Achievement Distribution</h2>
            </div>
            <div class="distribution-grid" id="achievementDistribution">
                <!-- Distribution items will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Student Detail Modal -->
    <div class="modal" id="studentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalStudentName">Student Progress</h2>
                <button class="close-modal" onclick="closeStudentModal()">√ó</button>
            </div>

            <div class="student-progress-grid">
                <div class="progress-card">
                    <div class="progress-label">Total Points</div>
                    <div class="progress-value" id="modalPoints">0</div>
                </div>
                <div class="progress-card">
                    <div class="progress-label">Current Level</div>
                    <div class="progress-value" id="modalLevel">1</div>
                </div>
                <div class="progress-card">
                    <div class="progress-label">Achievements</div>
                    <div class="progress-value" id="modalAchievements">0</div>
                </div>
                <div class="progress-card">
                    <div class="progress-label">Participation Rate</div>
                    <div class="progress-value" id="modalParticipation">0%</div>
                </div>
            </div>

            <div class="progress-card" style="margin-bottom: 1.5rem;">
                <div class="progress-label">Level Progress</div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="modalLevelProgress" style="width: 0%"></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                    <span id="modalCurrentXP">0 XP</span>
                    <span id="modalNextLevelXP">100 XP</span>
                </div>
            </div>

            <h3 style="margin-bottom: 1rem;">Achievements</h3>
            <div class="achievement-showcase" id="modalAchievementList">
                <!-- Student achievements will be loaded here -->
            </div>

            <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Recent Activity</h3>
            <div id="modalActivityList">
                <!-- Recent activity will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let currentInstructorId = null;
        let currentClassId = null;
        let leaderboardData = [];
        let currentLeaderboardFilter = 'points';
        let currentChartPeriod = 'week';

        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadClasses();
            await loadDashboardData();

            // Auto-refresh every 30 seconds
            setInterval(() => {
                loadDashboardData(true);
            }, 30000);
        });

        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            // Get instructor ID from token
            const payload = JSON.parse(atob(token.split('.')[1]));
            currentInstructorId = payload.userId || payload.id;
        }

        async function loadClasses() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('https://api.intellaclick.com/api/classes', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load classes');

                const data = await response.json();
                const classes = data.classes || [];

                const selector = document.getElementById('classSelector');
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls._id || cls.id;
                    option.textContent = cls.name;
                    selector.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        async function loadDashboardData(silent = false) {
            try {
                if (!silent) {
                    document.getElementById('refreshIndicator').style.display = 'inline-flex';
                }

                const token = localStorage.getItem('token');
                currentClassId = document.getElementById('classSelector').value || null;

                // Build API URL
                let url = `https://api.intellaclick.com/api/gamification/leaderboard/instructor/${currentInstructorId}`;
                if (currentClassId) {
                    url += `?classId=${currentClassId}`;
                }

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load dashboard data');

                const data = await response.json();
                leaderboardData = data.leaderboard || [];

                // Update stats
                updateStats(data);

                // Render leaderboard
                renderLeaderboard();

                // Load recent achievements
                await loadRecentAchievements();

                // Load engagement chart
                await loadEngagementChart();

                // Load achievement distribution
                await loadAchievementDistribution();

                document.getElementById('refreshIndicator').style.display = 'none';
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                document.getElementById('refreshIndicator').style.display = 'none';

                if (!silent) {
                    alert('Failed to load dashboard data. Please try again.');
                }
            }
        }

        function updateStats(data) {
            // Total students
            const totalStudents = leaderboardData.length;
            document.getElementById('totalStudents').textContent = totalStudents;

            // Total points
            const totalPoints = leaderboardData.reduce((sum, student) => sum + (student.totalPoints || 0), 0);
            document.getElementById('totalPoints').textContent = totalPoints.toLocaleString();

            // Total achievements
            const totalAchievements = leaderboardData.reduce((sum, student) => sum + (student.achievementCount || 0), 0);
            document.getElementById('totalAchievements').textContent = totalAchievements;

            // Average participation (placeholder - would need session data)
            const avgParticipation = leaderboardData.length > 0 ? 85 : 0;
            document.getElementById('avgParticipation').textContent = avgParticipation + '%';

            // Changes (placeholder - would need historical data)
            document.getElementById('studentsChange').textContent = `+${Math.floor(totalStudents * 0.1)} this week`;
            document.getElementById('pointsChange').textContent = `+${Math.floor(totalPoints * 0.15).toLocaleString()} this week`;
            document.getElementById('achievementsChange').textContent = `+${Math.floor(totalAchievements * 0.2)} this week`;
            document.getElementById('participationChange').textContent = '+5% this week';
        }

        function renderLeaderboard() {
            const container = document.getElementById('leaderboardList');
            const emptyState = document.getElementById('emptyLeaderboard');

            if (leaderboardData.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'flex';
            emptyState.style.display = 'none';

            // Sort based on current filter
            let sorted = [...leaderboardData];
            if (currentLeaderboardFilter === 'points') {
                sorted.sort((a, b) => (b.totalPoints || 0) - (a.totalPoints || 0));
            } else if (currentLeaderboardFilter === 'level') {
                sorted.sort((a, b) => (b.level || 0) - (a.level || 0));
            } else if (currentLeaderboardFilter === 'achievements') {
                sorted.sort((a, b) => (b.achievementCount || 0) - (a.achievementCount || 0));
            }

            container.innerHTML = sorted.map((student, index) => {
                const rank = index + 1;
                let rankClass = '';
                if (rank === 1) rankClass = 'gold';
                else if (rank === 2) rankClass = 'silver';
                else if (rank === 3) rankClass = 'bronze';

                const initials = student.name ? student.name.split(' ').map(n => n[0]).join('').toUpperCase() : '?';
                const displayValue = currentLeaderboardFilter === 'points'
                    ? (student.totalPoints || 0).toLocaleString()
                    : currentLeaderboardFilter === 'level'
                    ? `Level ${student.level || 1}`
                    : `${student.achievementCount || 0} achievements`;

                return `
                    <div class="leaderboard-item" onclick="viewStudentDetails('${student.playerId}')">
                        <div class="rank ${rankClass}">${rank}</div>
                        <div class="student-avatar">${initials}</div>
                        <div class="student-info">
                            <div class="student-name">${student.name || 'Student'}</div>
                            <div class="student-meta">${student.totalPoints || 0} points ‚Ä¢ ${student.achievementCount || 0} achievements</div>
                        </div>
                        <div class="student-points">
                            <div class="points-value">${displayValue}</div>
                            <div class="level-badge">Level ${student.level || 1}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterLeaderboard(filter) {
            currentLeaderboardFilter = filter;

            // Update active tab
            document.querySelectorAll('.filter-tabs .filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            renderLeaderboard();
        }

        async function loadRecentAchievements() {
            try {
                const token = localStorage.getItem('token');
                let url = `https://api.intellaclick.com/api/gamification/achievements/recent?instructorId=${currentInstructorId}&limit=10`;
                if (currentClassId) {
                    url += `&classId=${currentClassId}`;
                }

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load achievements');

                const data = await response.json();
                const achievements = data.achievements || [];

                const container = document.getElementById('recentAchievementsList');
                const emptyState = document.getElementById('emptyAchievements');

                if (achievements.length === 0) {
                    container.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }

                container.style.display = 'block';
                emptyState.style.display = 'none';

                container.innerHTML = achievements.map(ach => {
                    const timeAgo = getTimeAgo(new Date(ach.unlockedAt));
                    return `
                        <div class="achievement-item">
                            <div class="achievement-icon" style="background: ${ach.color || '#667eea'};">
                                ${ach.icon || 'üèÖ'}
                            </div>
                            <div class="achievement-details">
                                <div class="achievement-title">${ach.name}</div>
                                <div class="achievement-student">${ach.studentName || 'Student'}</div>
                                <div class="achievement-time">${timeAgo}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading recent achievements:', error);
                document.getElementById('emptyAchievements').style.display = 'block';
            }
        }

        async function loadEngagementChart() {
            const container = document.getElementById('engagementChart');

            // Mock data for now - would come from API
            const weekData = [65, 72, 68, 80, 75, 82, 78];
            const monthData = [70, 75, 72, 78, 80, 85, 82, 88, 84, 90, 87, 92, 89, 95, 91, 88, 85, 90, 92, 95, 93, 97, 94, 98, 96, 99, 97, 100, 98, 95];

            const data = currentChartPeriod === 'week' ? weekData : monthData;
            const labels = currentChartPeriod === 'week'
                ? ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
                : Array.from({length: 30}, (_, i) => (i + 1).toString());

            const maxValue = Math.max(...data);

            container.innerHTML = data.map((value, index) => {
                const height = (value / maxValue) * 100;
                return `
                    <div class="chart-bar" style="height: ${height}%;">
                        <div class="chart-bar-value">${value}</div>
                        <div class="chart-bar-label">${labels[index]}</div>
                    </div>
                `;
            }).join('');
        }

        function changeChartPeriod(period) {
            currentChartPeriod = period;

            // Update active tab
            const tabs = document.querySelectorAll('.chart-card .filter-tabs .filter-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            loadEngagementChart();
        }

        async function loadAchievementDistribution() {
            const container = document.getElementById('achievementDistribution');

            // Get achievement categories from leaderboard data
            const achievements = {
                'First Answer': { icon: 'üéØ', count: 0 },
                'Perfect Score': { icon: 'üíØ', count: 0 },
                'Speed Demon': { icon: '‚ö°', count: 0 },
                'Consistent': { icon: 'üî•', count: 0 },
                'Team Player': { icon: 'ü§ù', count: 0 },
                'Knowledge Master': { icon: 'üß†', count: 0 }
            };

            // Count achievements (would come from detailed API)
            leaderboardData.forEach(student => {
                if (student.achievements) {
                    student.achievements.forEach(ach => {
                        if (achievements[ach.name]) {
                            achievements[ach.name].count++;
                        }
                    });
                }
            });

            container.innerHTML = Object.entries(achievements).map(([name, data]) => `
                <div class="distribution-item">
                    <div class="distribution-icon">${data.icon}</div>
                    <div class="distribution-count">${data.count}</div>
                    <div class="distribution-label">${name}</div>
                </div>
            `).join('');
        }

        async function viewStudentDetails(playerId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`https://api.intellaclick.com/api/gamification/player/${playerId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load student details');

                const data = await response.json();
                const student = data.player;

                // Populate modal
                document.getElementById('modalStudentName').textContent = student.name || 'Student';
                document.getElementById('modalPoints').textContent = (student.totalPoints || 0).toLocaleString();
                document.getElementById('modalLevel').textContent = student.level || 1;
                document.getElementById('modalAchievements').textContent = student.achievements?.length || 0;
                document.getElementById('modalParticipation').textContent = (student.participationRate || 0) + '%';

                // Level progress
                const currentXP = student.experiencePoints || 0;
                const nextLevelXP = student.nextLevelXP || 100;
                const progress = (currentXP / nextLevelXP) * 100;
                document.getElementById('modalLevelProgress').style.width = progress + '%';
                document.getElementById('modalCurrentXP').textContent = currentXP + ' XP';
                document.getElementById('modalNextLevelXP').textContent = nextLevelXP + ' XP';

                // Achievements
                const achievementList = document.getElementById('modalAchievementList');
                if (student.achievements && student.achievements.length > 0) {
                    achievementList.innerHTML = student.achievements.map(ach => `
                        <div class="achievement-showcase-item">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">${ach.icon || 'üèÖ'}</div>
                            <div style="font-size: 0.75rem; font-weight: 600;">${ach.name}</div>
                        </div>
                    `).join('');
                } else {
                    achievementList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No achievements yet</p>';
                }

                // Recent activity
                const activityList = document.getElementById('modalActivityList');
                if (student.recentActivity && student.recentActivity.length > 0) {
                    activityList.innerHTML = student.recentActivity.map(activity => `
                        <div style="padding: 1rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 0.75rem;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">${activity.description}</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">${getTimeAgo(new Date(activity.timestamp))}</div>
                        </div>
                    `).join('');
                } else {
                    activityList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No recent activity</p>';
                }

                // Show modal
                document.getElementById('studentModal').classList.add('active');
            } catch (error) {
                console.error('Error loading student details:', error);
                alert('Failed to load student details');
            }
        }

        function closeStudentModal() {
            document.getElementById('studentModal').classList.remove('active');
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + ' days ago';
            return Math.floor(seconds / 604800) + ' weeks ago';
        }

        // Close modal when clicking outside
        document.getElementById('studentModal').addEventListener('click', (e) => {
            if (e.target.id === 'studentModal') {
                closeStudentModal();
            }
        });
    </script>
</body>
</html>
