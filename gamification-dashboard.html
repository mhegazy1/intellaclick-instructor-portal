<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamification Dashboard - IntellaClick</title>
    <link rel="stylesheet" href="styles/common.css">
    <link rel="stylesheet" href="styles/gamification-dashboard.css">
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>üèÜ Gamification Dashboard</h1>
            <div class="header-actions">
                <div class="refresh-indicator" id="refreshIndicator" style="display: none;">
                    <div class="spinner"></div>
                    <span>Refreshing...</span>
                </div>
                <button class="btn btn-secondary" onclick="window.location.href='../pages/gamification-settings.html'">
                    ‚öôÔ∏è Settings
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='../pages/classes.html'">
                    ‚Üê Back
                </button>
            </div>
        </div>

        <!-- Class Selector -->
        <div class="class-selector">
            <label><strong>Select Class:</strong></label>
            <select id="classSelector" onchange="loadDashboardData()">
                <option value="">All Classes (Instructor-wide)</option>
            </select>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">üë•</div>
                <div class="stat-value" id="totalStudents">0</div>
                <div class="stat-label">Active Students</div>
                <div class="stat-change positive" id="studentsChange">+0 this week</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">‚≠ê</div>
                <div class="stat-value" id="totalPoints">0</div>
                <div class="stat-label">Total Points Earned</div>
                <div class="stat-change positive" id="pointsChange">+0 this week</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon orange">üèÖ</div>
                <div class="stat-value" id="totalAchievements">0</div>
                <div class="stat-label">Achievements Unlocked</div>
                <div class="stat-change positive" id="achievementsChange">+0 this week</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon purple">üìä</div>
                <div class="stat-value" id="avgParticipation">0%</div>
                <div class="stat-label">Avg. Participation Rate</div>
                <div class="stat-change positive" id="participationChange">+0% this week</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="content-grid">
            <!-- Leaderboard -->
            <div class="leaderboard-card">
                <div class="card-header">
                    <h2 class="card-title">üèÜ Leaderboard</h2>
                    <div class="filter-tabs">
                        <button class="filter-tab active" onclick="filterLeaderboard('points')">Points</button>
                        <button class="filter-tab" onclick="filterLeaderboard('level')">Level</button>
                        <button class="filter-tab" onclick="filterLeaderboard('achievements')">Achievements</button>
                    </div>
                </div>
                <div class="leaderboard-list" id="leaderboardList">
                    <!-- Leaderboard items will be loaded here -->
                </div>
                <div id="emptyLeaderboard" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">üèÜ</div>
                    <p>No students have earned points yet</p>
                    <p style="font-size: 0.875rem;">Points will appear here after you run sessions with gamification enabled</p>
                </div>
            </div>

            <!-- Recent Achievements -->
            <div class="achievements-card">
                <div class="card-header">
                    <h2 class="card-title">üéâ Recent Achievements</h2>
                </div>
                <div id="recentAchievementsList">
                    <!-- Achievement items will be loaded here -->
                </div>
                <div id="emptyAchievements" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">üéâ</div>
                    <p>No achievements unlocked yet</p>
                </div>
            </div>
        </div>

        <!-- Engagement Chart -->
        <div class="chart-card">
            <div class="card-header">
                <h2 class="card-title">üìà Weekly Engagement</h2>
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="changeChartPeriod('week')">Week</button>
                    <button class="filter-tab" onclick="changeChartPeriod('month')">Month</button>
                </div>
            </div>
            <div class="chart-container" id="engagementChart">
                <!-- Chart bars will be generated here -->
            </div>
        </div>

        <!-- Achievement Distribution -->
        <div class="chart-card">
            <div class="card-header">
                <h2 class="card-title">üèÖ Achievement Distribution</h2>
            </div>
            <div class="distribution-grid" id="achievementDistribution">
                <!-- Distribution items will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Student Detail Modal -->
    <div class="modal" id="studentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalStudentName">Student Progress</h2>
                <button class="close-modal" onclick="closeStudentModal()">√ó</button>
            </div>

            <div class="student-progress-grid">
                <div class="progress-card">
                    <div class="progress-label">Total Points</div>
                    <div class="progress-value" id="modalPoints">0</div>
                </div>
                <div class="progress-card">
                    <div class="progress-label">Current Level</div>
                    <div class="progress-value" id="modalLevel">1</div>
                </div>
                <div class="progress-card">
                    <div class="progress-label">Achievements</div>
                    <div class="progress-value" id="modalAchievements">0</div>
                </div>
                <div class="progress-card">
                    <div class="progress-label">Participation Rate</div>
                    <div class="progress-value" id="modalParticipation">0%</div>
                </div>
            </div>

            <div class="progress-card" style="margin-bottom: 1.5rem;">
                <div class="progress-label">Level Progress</div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="modalLevelProgress" style="width: 0%"></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                    <span id="modalCurrentXP">0 XP</span>
                    <span id="modalNextLevelXP">100 XP</span>
                </div>
            </div>

            <h3 style="margin-bottom: 1rem;">Achievements</h3>
            <div class="achievement-showcase" id="modalAchievementList">
                <!-- Student achievements will be loaded here -->
            </div>

            <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Recent Activity</h3>
            <div id="modalActivityList">
                <!-- Recent activity will be loaded here -->
            </div>
        </div>
    </div>

    <script type="module">
        import { classes as classesAPI, gamification } from '../utils/api.js';
        import toast from '../utils/toast.js';
        import logger from '../utils/logger.js';

        let currentInstructorId = null;
        let currentClassId = null;
        let leaderboardData = [];
        let currentLeaderboardFilter = 'points';
        let currentChartPeriod = 'week';

        logger.debug('üîµ Gamification Dashboard Loaded - Version 1.0.0-modular');

        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadClasses();
            await loadDashboardData();

            // Auto-refresh every 30 seconds
            setInterval(() => {
                loadDashboardData(true);
            }, 30000);
        });

        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '../pages/login.html';
                return;
            }

            // Get instructor ID from token
            const payload = JSON.parse(atob(token.split('.')[1]));
            currentInstructorId = payload.userId || payload.id;
        }

        async function loadClasses() {
            try {
                const data = await classesAPI.getAll();
                const classes = data.classes || [];

                const selector = document.getElementById('classSelector');
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls._id || cls.id;
                    option.textContent = cls.name;
                    selector.appendChild(option);
                });
            } catch (error) {
                logger.error('Error loading classes:', error);
                toast.error('Failed to load classes');
            }
        }

        async function loadDashboardData(silent = false) {
            try {
                if (!silent) {
                    document.getElementById('refreshIndicator').style.display = 'inline-flex';
                }

                currentClassId = document.getElementById('classSelector').value || null;

                logger.debug('üîç Loading dashboard data:', {
                    currentClassId,
                    currentInstructorId,
                    isAllClasses: !currentClassId
                });

                let allLeaderboardData = [];

                if (!currentClassId) {
                    // "All Classes" selected - fetch all classes and combine leaderboards
                    const classesData = await classesAPI.getAll();
                    const classes = classesData.classes || [];

                    logger.debug('üìö Fetching leaderboards for', classes.length, 'classes');

                    // Fetch leaderboard for each class
                    for (const cls of classes) {
                        try {
                            const data = await gamification.getLeaderboard(cls._id || cls.id);
                            if (data.leaderboard && data.leaderboard.length > 0) {
                                allLeaderboardData.push(...data.leaderboard);
                            }
                        } catch (err) {
                            logger.warn(`Failed to load leaderboard for class ${cls.name}:`, err);
                        }
                    }

                    // Combine duplicate students (in case student is in multiple classes)
                    const studentMap = new Map();
                    allLeaderboardData.forEach(student => {
                        const existing = studentMap.get(student.studentId);
                        if (existing) {
                            // Sum points from multiple classes
                            existing.totalPoints = (existing.totalPoints || 0) + (student.totalPoints || 0);
                            existing.level = Math.max(existing.level || 1, student.level || 1);
                            existing.achievementCount = (existing.achievementCount || 0) + (student.achievementCount || 0);
                        } else {
                            studentMap.set(student.studentId, {...student});
                        }
                    });

                    leaderboardData = Array.from(studentMap.values());
                    logger.debug('üë• Combined leaderboard data:', leaderboardData.length, 'students');
                } else {
                    // Specific class selected
                    const data = await gamification.getLeaderboard(currentClassId);
                    logger.debug('üìä Leaderboard response:', data);

                    leaderboardData = data.leaderboard || [];
                    logger.debug('üë• Leaderboard data:', leaderboardData.length, 'students');
                }

                // Update stats
                updateStats();

                // Render leaderboard
                renderLeaderboard();

                // Load recent achievements
                await loadRecentAchievements();

                // Load engagement chart
                await loadEngagementChart();

                // Load achievement distribution
                await loadAchievementDistribution();

                document.getElementById('refreshIndicator').style.display = 'none';
            } catch (error) {
                logger.error('‚ùå Error loading dashboard data:', error);
                document.getElementById('refreshIndicator').style.display = 'none';

                if (!silent) {
                    toast.error('Failed to load dashboard data');
                }
            }
        }

        function updateStats(data) {
            // Total students
            const totalStudents = leaderboardData.length;
            document.getElementById('totalStudents').textContent = totalStudents;

            // Total points
            const totalPoints = leaderboardData.reduce((sum, student) => sum + (student.points || 0), 0);
            document.getElementById('totalPoints').textContent = totalPoints.toLocaleString();

            // Total achievements
            const totalAchievements = leaderboardData.reduce((sum, student) => sum + (student.achievementCount || 0), 0);
            document.getElementById('totalAchievements').textContent = totalAchievements;

            // Average participation (placeholder - would need session data)
            const avgParticipation = leaderboardData.length > 0 ? 85 : 0;
            document.getElementById('avgParticipation').textContent = avgParticipation + '%';

            // Changes (placeholder - would need historical data)
            document.getElementById('studentsChange').textContent = `+${Math.floor(totalStudents * 0.1)} this week`;
            document.getElementById('pointsChange').textContent = `+${Math.floor(totalPoints * 0.15).toLocaleString()} this week`;
            document.getElementById('achievementsChange').textContent = `+${Math.floor(totalAchievements * 0.2)} this week`;
            document.getElementById('participationChange').textContent = '+5% this week';
        }

        function renderLeaderboard() {
            const container = document.getElementById('leaderboardList');
            const emptyState = document.getElementById('emptyLeaderboard');

            if (leaderboardData.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'flex';
            emptyState.style.display = 'none';

            // Sort based on current filter
            let sorted = [...leaderboardData];
            if (currentLeaderboardFilter === 'points') {
                sorted.sort((a, b) => (b.points || 0) - (a.points || 0));
            } else if (currentLeaderboardFilter === 'level') {
                sorted.sort((a, b) => (b.level || 0) - (a.level || 0));
            } else if (currentLeaderboardFilter === 'achievements') {
                sorted.sort((a, b) => (b.achievementCount || 0) - (a.achievementCount || 0));
            }

            container.innerHTML = sorted.map((student, index) => {
                const rank = index + 1;
                let rankClass = '';
                if (rank === 1) rankClass = 'gold';
                else if (rank === 2) rankClass = 'silver';
                else if (rank === 3) rankClass = 'bronze';

                const initials = student.studentName ? student.studentName.split(' ').map(n => n[0]).join('').toUpperCase() : '?';
                const displayValue = currentLeaderboardFilter === 'points'
                    ? (student.points || 0).toLocaleString()
                    : currentLeaderboardFilter === 'level'
                    ? `Level ${student.level || 1}`
                    : `${student.achievementCount || 0} achievements`;

                return `
                    <div class="leaderboard-item" onclick="viewStudentDetails('${student.studentId}')">
                        <div class="rank ${rankClass}">${rank}</div>
                        <div class="student-avatar">${initials}</div>
                        <div class="student-info">
                            <div class="student-name">${student.studentName || 'Student'}</div>
                            <div class="student-meta">${student.points || 0} points ‚Ä¢ ${student.achievementCount || 0} achievements</div>
                        </div>
                        <div class="student-points">
                            <div class="points-value">${displayValue}</div>
                            <div class="level-badge">Level ${student.level || 1}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterLeaderboard(filter) {
            currentLeaderboardFilter = filter;

            // Update active tab
            document.querySelectorAll('.leaderboard-card .filter-tabs .filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            renderLeaderboard();
        }

        async function loadRecentAchievements() {
            try {
                // Mock data for now - would use API endpoint
                const achievements = [];

                const container = document.getElementById('recentAchievementsList');
                const emptyState = document.getElementById('emptyAchievements');

                if (achievements.length === 0) {
                    container.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }

                container.style.display = 'block';
                emptyState.style.display = 'none';

                container.innerHTML = achievements.map(ach => {
                    const timeAgo = getTimeAgo(new Date(ach.unlockedAt));
                    return `
                        <div class="achievement-item">
                            <div class="achievement-icon" style="background: ${ach.color || '#667eea'};">
                                ${ach.icon || 'üèÖ'}
                            </div>
                            <div class="achievement-details">
                                <div class="achievement-title">${ach.name}</div>
                                <div class="achievement-student">${ach.studentName || 'Student'}</div>
                                <div class="achievement-time">${timeAgo}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                logger.error('Error loading recent achievements:', error);
                document.getElementById('emptyAchievements').style.display = 'block';
            }
        }

        async function loadEngagementChart() {
            const container = document.getElementById('engagementChart');

            // Mock data for now - would come from API
            const weekData = [65, 72, 68, 80, 75, 82, 78];
            const monthData = [70, 75, 72, 78, 80, 85, 82, 88, 84, 90, 87, 92, 89, 95, 91, 88, 85, 90, 92, 95, 93, 97, 94, 98, 96, 99, 97, 100, 98, 95];

            const data = currentChartPeriod === 'week' ? weekData : monthData;
            const labels = currentChartPeriod === 'week'
                ? ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
                : Array.from({length: 30}, (_, i) => (i + 1).toString());

            const maxValue = Math.max(...data);

            container.innerHTML = data.map((value, index) => {
                const height = (value / maxValue) * 100;
                return `
                    <div class="chart-bar" style="height: ${height}%;">
                        <div class="chart-bar-value">${value}</div>
                        <div class="chart-bar-label">${labels[index]}</div>
                    </div>
                `;
            }).join('');
        }

        function changeChartPeriod(period) {
            currentChartPeriod = period;

            // Update active tab
            const tabs = document.querySelectorAll('.chart-card .filter-tabs .filter-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            loadEngagementChart();
        }

        async function loadAchievementDistribution() {
            const container = document.getElementById('achievementDistribution');

            // Get achievement categories from leaderboard data
            const achievements = {
                'First Answer': { icon: 'üéØ', count: 0 },
                'Perfect Score': { icon: 'üíØ', count: 0 },
                'Speed Demon': { icon: '‚ö°', count: 0 },
                'Consistent': { icon: 'üî•', count: 0 },
                'Team Player': { icon: 'ü§ù', count: 0 },
                'Knowledge Master': { icon: 'üß†', count: 0 }
            };

            // Count achievements (would come from detailed API)
            leaderboardData.forEach(student => {
                if (student.achievements) {
                    student.achievements.forEach(ach => {
                        if (achievements[ach.name]) {
                            achievements[ach.name].count++;
                        }
                    });
                }
            });

            container.innerHTML = Object.entries(achievements).map(([name, data]) => `
                <div class="distribution-item">
                    <div class="distribution-icon">${data.icon}</div>
                    <div class="distribution-count">${data.count}</div>
                    <div class="distribution-label">${name}</div>
                </div>
            `).join('');
        }

        async function viewStudentDetails(playerId) {
            try {
                const data = await gamification.getStudentStats(currentClassId || currentInstructorId, playerId);
                const student = data.player;

                // Populate modal
                document.getElementById('modalStudentName').textContent = student.name || 'Student';
                document.getElementById('modalPoints').textContent = (student.totalPoints || 0).toLocaleString();
                document.getElementById('modalLevel').textContent = student.level || 1;
                document.getElementById('modalAchievements').textContent = student.achievements?.length || 0;
                document.getElementById('modalParticipation').textContent = (student.participationRate || 0) + '%';

                // Level progress
                const currentXP = student.experiencePoints || 0;
                const nextLevelXP = student.nextLevelXP || 100;
                const progress = (currentXP / nextLevelXP) * 100;
                document.getElementById('modalLevelProgress').style.width = progress + '%';
                document.getElementById('modalCurrentXP').textContent = currentXP + ' XP';
                document.getElementById('modalNextLevelXP').textContent = nextLevelXP + ' XP';

                // Achievements
                const achievementList = document.getElementById('modalAchievementList');
                if (student.achievements && student.achievements.length > 0) {
                    achievementList.innerHTML = student.achievements.map(ach => `
                        <div class="achievement-showcase-item">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">${ach.icon || 'üèÖ'}</div>
                            <div style="font-size: 0.75rem; font-weight: 600;">${ach.name}</div>
                        </div>
                    `).join('');
                } else {
                    achievementList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No achievements yet</p>';
                }

                // Recent activity
                const activityList = document.getElementById('modalActivityList');
                if (student.recentActivity && student.recentActivity.length > 0) {
                    activityList.innerHTML = student.recentActivity.map(activity => `
                        <div style="padding: 1rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 0.75rem;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">${activity.description}</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">${getTimeAgo(new Date(activity.timestamp))}</div>
                        </div>
                    `).join('');
                } else {
                    activityList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No recent activity</p>';
                }

                // Show modal
                document.getElementById('studentModal').classList.add('active');
            } catch (error) {
                logger.error('Error loading student details:', error);
                toast.error('Failed to load student details');
            }
        }

        function closeStudentModal() {
            document.getElementById('studentModal').classList.remove('active');
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + ' days ago';
            return Math.floor(seconds / 604800) + ' weeks ago';
        }

        // Close modal when clicking outside
        document.getElementById('studentModal').addEventListener('click', (e) => {
            if (e.target.id === 'studentModal') {
                closeStudentModal();
            }
        });

        // Expose functions to window for onclick handlers
        window.loadDashboardData = loadDashboardData;
        window.filterLeaderboard = filterLeaderboard;
        window.changeChartPeriod = changeChartPeriod;
        window.viewStudentDetails = viewStudentDetails;
        window.closeStudentModal = closeStudentModal;
    </script>
</body>
</html>
