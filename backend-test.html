<!DOCTYPE html>
<html>
<head>
    <title>Backend API Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        pre {
            background: #1e293b;
            color: #f1f5f9;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        .error { color: #ef4444; }
        .success { color: #10b981; }
        .warning { color: #f59e0b; }
    </style>
</head>
<body>
    <h1>Backend API Test - Delete Issue Diagnosis</h1>
    
    <div class="test-section">
        <h2>Test Sequence</h2>
        <p>This will run a series of tests to diagnose why delete is failing:</p>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>
    
    <div class="test-section">
        <h2>Results</h2>
        <pre id="results">Click "Run All Tests" to begin...</pre>
    </div>

    <script>
        const resultsEl = document.getElementById('results');
        const API_URL = 'https://api.intellaclick.com';
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#64748b';
            resultsEl.innerHTML += `<span style="color: ${color}">${timestamp}: ${message}</span>\n`;
        }
        
        function clearResults() {
            resultsEl.innerHTML = '';
        }
        
        async function makeRequest(endpoint, options = {}) {
            const token = localStorage.getItem('token');
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            };
            
            const response = await fetch(`${API_URL}${endpoint}`, {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            });
            
            const data = await response.json().catch(() => ({ error: 'Invalid JSON response' }));
            return { response, data };
        }
        
        async function runAllTests() {
            clearResults();
            log('Starting comprehensive backend test...\n');
            
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            // Test 1: Token and User Info
            log('=== TEST 1: Local Storage Check ===');
            log(`Token exists: ${!!token}`);
            log(`User ID: ${user.id || user._id || 'NOT FOUND'}`);
            log(`User Role: ${user.role || 'NOT FOUND'}`);
            log(`User Email: ${user.email || 'NOT FOUND'}`);
            
            // Decode token
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                log(`Token payload: ${JSON.stringify(payload)}`);
            } catch (e) {
                log('Could not decode token', 'error');
            }
            
            // Test 2: Get Classes
            log('\n=== TEST 2: Get Classes ===');
            const classesResult = await makeRequest('/api/classes');
            
            if (classesResult.response.ok) {
                log(`Found ${classesResult.data.classes.length} classes`, 'success');
                
                if (classesResult.data.classes.length > 0) {
                    const firstClass = classesResult.data.classes[0];
                    const instructorId = typeof firstClass.instructorId === 'object' 
                        ? firstClass.instructorId._id 
                        : firstClass.instructorId;
                    
                    log(`First class: ${firstClass.name}`);
                    log(`Class ID: ${firstClass._id}`);
                    log(`Instructor ID: ${instructorId}`);
                    log(`Join Code: ${firstClass.joinCode}`);
                    
                    // Test 3: Debug endpoint (if available)
                    log('\n=== TEST 3: Debug Endpoint ===');
                    const debugResult = await makeRequest('/api/debug-classes/raw');
                    
                    if (debugResult.response.ok) {
                        log('Debug endpoint available!', 'success');
                        log(`Your user ID from backend: ${debugResult.data.userId}`);
                        log(`Classes found: ${debugResult.data.classCount}`);
                        
                        if (debugResult.data.classes.length > 0) {
                            const firstDebugClass = debugResult.data.classes[0];
                            log(`\nFirst class ownership check:`);
                            log(`Class: ${firstDebugClass.name}`);
                            log(`Instructor ID: ${firstDebugClass.instructorId}`);
                            log(`Is Owner: ${firstDebugClass.isOwner ? 'YES' : 'NO'}`);
                        }
                    } else {
                        log('Debug endpoint not available (backend not updated?)', 'warning');
                    }
                    
                    // Test 4: Try to delete
                    log('\n=== TEST 4: Delete Test ===');
                    log(`Attempting to delete: ${firstClass.name}`);
                    
                    const deleteResult = await makeRequest(`/api/classes/${firstClass._id}`, {
                        method: 'DELETE'
                    });
                    
                    log(`Delete response status: ${deleteResult.response.status}`);
                    
                    if (deleteResult.response.ok) {
                        log('DELETE SUCCESSFUL!', 'success');
                        log(`Response: ${JSON.stringify(deleteResult.data)}`, 'success');
                    } else {
                        log('DELETE FAILED', 'error');
                        log(`Error response: ${JSON.stringify(deleteResult.data, null, 2)}`, 'error');
                        
                        // Test 5: Check specific ownership
                        if (deleteResult.response.status === 403) {
                            log('\n=== TEST 5: Ownership Debug ===');
                            const ownershipResult = await makeRequest(`/api/debug-classes/check/${firstClass._id}`);
                            
                            if (ownershipResult.response.ok) {
                                log('Ownership check result:');
                                log(`Class instructor ID: ${ownershipResult.data.class?.instructorIdString}`);
                                log(`Your user ID: ${ownershipResult.data.user?.userIdString}`);
                                log(`Is owner: ${ownershipResult.data.ownership?.isOwner ? 'YES' : 'NO'}`);
                                log(`Comparison: ${ownershipResult.data.ownership?.comparison}`);
                            } else {
                                log('Could not check ownership', 'error');
                            }
                        }
                    }
                }
            } else {
                log('Failed to get classes', 'error');
                log(`Error: ${JSON.stringify(classesResult.data)}`, 'error');
            }
            
            // Test 6: Check if instructorAuth is the issue
            log('\n=== TEST 6: Role Check ===');
            log('If delete failed with "Instructor privileges required", the issue is role-based');
            log('If delete failed with "Access denied", the issue is ownership-based');
            
            log('\n=== DIAGNOSIS COMPLETE ===');
        }
    </script>
</body>
</html>