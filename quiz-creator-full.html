<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Quiz - IntellaClick</title>
    <link rel="stylesheet" href="styles/common.css">
    <link rel="stylesheet" href="styles/create-session.css">
</head>
<body>
    <div class="container">
        <a href="quizzes.html" class="back-link">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Quizzes
        </a>

        <div class="header">
            <h1>Create New Quiz</h1>
        </div>

        <div class="section">
            <h2>Quiz Information</h2>
            <form id="quizForm">
                <div class="form-group">
                    <label for="quizTitle">Quiz Title *</label>
                    <input type="text" id="quizTitle" placeholder="e.g., Chapter 3 Quiz" required>
                </div>

                <div class="form-group">
                    <label for="quizDescription">Description (Optional)</label>
                    <textarea id="quizDescription" rows="3" placeholder="Brief description of the quiz"></textarea>
                </div>

                <!-- Questions Section -->
                <div class="form-group">
                    <hr style="margin: 24px 0; border: none; border-top: 1px solid #e0e0e0;">
                    <h2 style="margin-bottom: 16px;">Quiz Questions</h2>

                    <!-- Questions List -->
                    <div id="questionsList" style="margin-bottom: 20px;"></div>

                    <label for="questionText">Add Question *</label>
                    <textarea id="questionText" rows="3" placeholder="Enter your question here..."></textarea>
                    <button type="button" class="btn btn-secondary" onclick="insertBlank()" style="margin-top: 8px; font-size: 0.9rem; padding: 0.5rem 1rem;">
                        Insert [blank] at cursor
                    </button>

                    <label style="margin-top: 16px;">Question Type</label>
                    <select id="questionType" onchange="updateQuestionOptions()">
                        <option value="mcq">Multiple Choice</option>
                        <option value="poll">Poll (No Correct Answer)</option>
                        <option value="tf">True/False</option>
                        <option value="matching">Matching</option>
                        <option value="ordering">Put in Order</option>
                        <option value="fillblank">Fill in the Blank</option>
                    </select>

                    <!-- Multiple Choice Options -->
                    <div id="mcqOptions" style="margin-top: 16px;">
                        <label>Answer Options</label>
                        <div id="mcqOptionsContainer" class="radio-group" style="flex-direction: column; gap: 10px;">
                            <!-- Options will be added dynamically -->
                        </div>
                        <div style="margin-top: 8px; display: flex; gap: 8px;">
                            <button type="button" class="btn btn-secondary btn-small" onclick="addMcqOption()">+ Add Option</button>
                            <button type="button" class="btn btn-secondary btn-small" onclick="removeMcqOption()">- Remove Last</button>
                        </div>
                        <small style="color: var(--text-secondary); margin-top: 8px; display: block;">Select the radio button next to the correct answer</small>
                    </div>

                    <!-- Poll Options (No Correct Answer) -->
                    <div id="pollOptions" style="margin-top: 16px; display: none;">
                        <label>Poll Options</label>
                        <div id="pollOptionsContainer" style="display: flex; flex-direction: column; gap: 10px;">
                            <!-- Options will be added dynamically -->
                        </div>
                        <div style="margin-top: 8px; display: flex; gap: 8px;">
                            <button type="button" class="btn btn-secondary btn-small" onclick="addPollOption()">+ Add Option</button>
                            <button type="button" class="btn btn-secondary btn-small" onclick="removePollOption()">- Remove Last</button>
                        </div>
                        <div style="margin-top: 12px;">
                            <label style="display: flex; align-items: center; gap: 8px; font-weight: normal; cursor: pointer;">
                                <input type="checkbox" id="pollParticipationPoints" style="width: auto; margin: 0;">
                                <span>Award points for participation (no wrong answer)</span>
                            </label>
                        </div>
                        <small style="color: var(--text-secondary); margin-top: 8px; display: block;">No correct answer - results will show distribution</small>
                    </div>

                    <!-- True/False Options -->
                    <div id="tfOptions" style="margin-top: 16px; display: none;">
                        <label>Correct Answer</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" name="tfAnswer" value="true" checked>
                                <label>True</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="tfAnswer" value="false">
                                <label>False</label>
                            </div>
                        </div>
                    </div>

                    <!-- Matching Options -->
                    <div id="matchingOptions" style="margin-top: 16px; display: none;">
                        <label>Matching Pairs</label>
                        <div id="matchingPairsContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px;">
                            <!-- Pairs will be added dynamically -->
                        </div>
                        <div style="margin-top: 8px; display: flex; gap: 8px;">
                            <button type="button" class="btn btn-secondary btn-small" onclick="addMatchingPair()">+ Add Pair</button>
                            <button type="button" class="btn btn-secondary btn-small" onclick="removeMatchingPair()">- Remove Last</button>
                        </div>
                    </div>

                    <!-- Ordering Options -->
                    <div id="orderingOptions" style="margin-top: 16px; display: none;">
                        <label>Items in Correct Order</label>
                        <div id="orderingItemsContainer" style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
                            <!-- Items will be added dynamically -->
                        </div>
                        <div style="margin-top: 8px; display: flex; gap: 8px;">
                            <button type="button" class="btn btn-secondary btn-small" onclick="addOrderingItem()">+ Add Item</button>
                            <button type="button" class="btn btn-secondary btn-small" onclick="removeOrderingItem()">- Remove Last</button>
                        </div>
                        <small style="color: var(--text-secondary); margin-top: 8px; display: block;">Enter items in the correct order</small>
                    </div>

                    <!-- Fill in the Blank Options -->
                    <div id="fillblankOptions" style="margin-top: 16px; display: none;">
                        <label>Correct Answer(s)</label>
                        <input type="text" id="blankAnswer" placeholder="Enter the correct answer" style="margin-top: 8px;">
                        <small style="color: var(--text-secondary); margin-top: 8px; display: block;">Use [blank] in your question text where the answer should go</small>
                    </div>

                    <!-- Add Question Button -->
                    <div style="margin-top: 16px; display: flex; gap: 8px;">
                        <button type="button" class="btn btn-primary" onclick="addQuestion()">+ Add This Question</button>
                        <button type="button" class="btn btn-secondary" id="cancelEditBtn" onclick="cancelEditQuestion()" style="display: none;">Cancel</button>
                    </div>
                </div>

                <div class="btn-group" style="margin-top: 32px;">
                    <button type="button" class="btn btn-secondary" onclick="cancelQuiz()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveButton">Save Quiz</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script type="module">
        import { quizzes } from './utils/api.js';
        import toast from './utils/toast.js';
        import logger from './utils/logger.js';

        let quizQuestions = [];
        let editingQuizId = null;
        let editingQuestionIndex = null; // Track which question is being edited
        let mcqOptionCount = 4; // Start with 4 options
        let pollOptionCount = 4; // Start with 4 options
        let matchingPairCount = 4; // Start with 4 pairs
        let orderingItemCount = 4; // Start with 4 items

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            document.getElementById('quizForm').addEventListener('submit', handleSaveQuiz);

            // Initialize dynamic options
            initializeMcqOptions(4);
            initializePollOptions(4);
            initializeMatchingPairs(4);
            initializeOrderingItems(4);

            updateQuestionOptions(); // Show default MCQ options

            // Check if editing existing quiz
            const urlParams = new URLSearchParams(window.location.search);
            const quizId = urlParams.get('id');
            if (quizId) {
                loadExistingQuiz(quizId);
            }
        });

        // Initialize MCQ options with specified count
        function initializeMcqOptions(count) {
            mcqOptionCount = count;
            const container = document.getElementById('mcqOptionsContainer');

            // Save existing values
            const existingValues = {};
            let selectedAnswer = null;
            for (let i = 0; i < 26; i++) {
                const letter = String.fromCharCode(65 + i);
                const input = document.getElementById(`option${letter}`);
                const radio = document.querySelector(`input[name="correctAnswer"][value="${letter}"]`);
                if (input) existingValues[letter] = input.value;
                if (radio && radio.checked) selectedAnswer = letter;
            }

            container.innerHTML = '';

            for (let i = 0; i < count; i++) {
                const letter = String.fromCharCode(65 + i);
                const div = document.createElement('div');
                div.className = 'radio-option';
                div.innerHTML = `
                    <input type="radio" name="correctAnswer" value="${letter}" ${selectedAnswer === letter || (i === 0 && !selectedAnswer) ? 'checked' : ''}>
                    <input type="text" id="option${letter}" placeholder="Option ${letter}" value="${existingValues[letter] || ''}" style="width: calc(100% - 40px); margin-left: 8px;">
                `;
                container.appendChild(div);
            }
        }

        // Initialize Poll options with specified count
        function initializePollOptions(count) {
            pollOptionCount = count;
            const container = document.getElementById('pollOptionsContainer');

            // Save existing values
            const existingValues = {};
            for (let i = 0; i < 26; i++) {
                const letter = String.fromCharCode(65 + i);
                const input = document.getElementById(`pollOption${letter}`);
                if (input) existingValues[letter] = input.value;
            }

            container.innerHTML = '';

            for (let i = 0; i < count; i++) {
                const letter = String.fromCharCode(65 + i);
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `pollOption${letter}`;
                input.placeholder = `Option ${letter}`;
                input.value = existingValues[letter] || '';
                input.style.width = '100%';
                container.appendChild(input);
            }
        }

        // Add MCQ option
        function addMcqOption() {
            if (mcqOptionCount >= 26) {
                toast.error('Maximum 26 options allowed');
                return;
            }
            mcqOptionCount++;
            initializeMcqOptions(mcqOptionCount);
        }

        // Remove MCQ option
        function removeMcqOption() {
            if (mcqOptionCount <= 2) {
                toast.error('Minimum 2 options required');
                return;
            }
            mcqOptionCount--;
            initializeMcqOptions(mcqOptionCount);
        }

        // Add Poll option
        function addPollOption() {
            if (pollOptionCount >= 26) {
                toast.error('Maximum 26 options allowed');
                return;
            }
            pollOptionCount++;
            initializePollOptions(pollOptionCount);
        }

        // Remove Poll option
        function removePollOption() {
            if (pollOptionCount <= 2) {
                toast.error('Minimum 2 options required');
                return;
            }
            pollOptionCount--;
            initializePollOptions(pollOptionCount);
        }

        // Initialize Matching pairs with specified count
        function initializeMatchingPairs(count) {
            matchingPairCount = count;
            const container = document.getElementById('matchingPairsContainer');

            // Save existing values
            const existingValues = {};
            for (let i = 1; i <= 10; i++) {
                const leftInput = document.getElementById(`match${i}Left`);
                const rightInput = document.getElementById(`match${i}Right`);
                if (leftInput) existingValues[`${i}Left`] = leftInput.value;
                if (rightInput) existingValues[`${i}Right`] = rightInput.value;
            }

            container.innerHTML = '';

            for (let i = 0; i < count; i++) {
                const num = i + 1;
                const leftInput = document.createElement('input');
                leftInput.type = 'text';
                leftInput.id = `match${num}Left`;
                leftInput.placeholder = `Item ${num}`;
                leftInput.value = existingValues[`${num}Left`] || '';
                leftInput.style.width = '100%';

                const rightInput = document.createElement('input');
                rightInput.type = 'text';
                rightInput.id = `match${num}Right`;
                rightInput.placeholder = `Match ${num}`;
                rightInput.value = existingValues[`${num}Right`] || '';
                rightInput.style.width = '100%';

                container.appendChild(leftInput);
                container.appendChild(rightInput);
            }
        }

        function addMatchingPair() {
            if (matchingPairCount >= 10) {
                toast.error('Maximum 10 pairs allowed');
                return;
            }
            matchingPairCount++;
            initializeMatchingPairs(matchingPairCount);
        }

        function removeMatchingPair() {
            if (matchingPairCount <= 2) {
                toast.error('Minimum 2 pairs required');
                return;
            }
            matchingPairCount--;
            initializeMatchingPairs(matchingPairCount);
        }

        // Initialize Ordering items with specified count
        function initializeOrderingItems(count) {
            orderingItemCount = count;
            const container = document.getElementById('orderingItemsContainer');

            // Save existing values
            const existingValues = {};
            for (let i = 1; i <= 10; i++) {
                const input = document.getElementById(`order${i}`);
                if (input) existingValues[i] = input.value;
            }

            container.innerHTML = '';

            for (let i = 0; i < count; i++) {
                const num = i + 1;
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `order${num}`;
                input.placeholder = `${getOrdinal(num)} item`;
                input.value = existingValues[num] || '';
                input.style.width = '100%';
                container.appendChild(input);
            }
        }

        function addOrderingItem() {
            if (orderingItemCount >= 10) {
                toast.error('Maximum 10 items allowed');
                return;
            }
            orderingItemCount++;
            initializeOrderingItems(orderingItemCount);
        }

        function removeOrderingItem() {
            if (orderingItemCount <= 2) {
                toast.error('Minimum 2 items required');
                return;
            }
            orderingItemCount--;
            initializeOrderingItems(orderingItemCount);
        }

        function getOrdinal(num) {
            const suffixes = ['th', 'st', 'nd', 'rd'];
            const value = num % 100;
            return num + (suffixes[(value - 20) % 10] || suffixes[value] || suffixes[0]);
        }

        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
            }
        }

        async function loadExistingQuiz(quizId) {
            try {
                logger.debug('Loading quiz for editing:', quizId);
                const result = await quizzes.getById(quizId);
                const quiz = result.quiz || result;

                // Store the quiz ID for updating
                editingQuizId = quizId;

                // Populate quiz details
                document.getElementById('quizTitle').value = quiz.title || '';
                document.getElementById('quizDescription').value = quiz.description || '';

                // Update header
                document.querySelector('.header h1').textContent = 'Edit Quiz';

                // Update button text
                document.getElementById('saveButton').textContent = 'Update Quiz';

                // Load questions from quiz
                if (quiz.questions && quiz.questions.length > 0) {
                    quizQuestions = quiz.questions.map(q => {
                        const snapshot = q.questionSnapshot || {};
                        return {
                            questionText: snapshot.questionText || '',
                            questionType: snapshot.questionType || 'mcq',
                            options: snapshot.options || [],
                            correctAnswer: snapshot.correctAnswer,
                            pairs: snapshot.pairs,
                            correctOrder: snapshot.correctOrder,
                            points: q.points || 10
                        };
                    });

                    renderQuestionsList();
                }

                toast.success('Quiz loaded for editing');
            } catch (error) {
                logger.error('Error loading quiz:', error);
                toast.error('Failed to load quiz: ' + error.message);
            }
        }

        function updateQuestionOptions() {
            const questionType = document.getElementById('questionType').value;

            // Hide all option divs
            document.getElementById('mcqOptions').style.display = 'none';
            document.getElementById('pollOptions').style.display = 'none';
            document.getElementById('tfOptions').style.display = 'none';
            document.getElementById('matchingOptions').style.display = 'none';
            document.getElementById('orderingOptions').style.display = 'none';
            document.getElementById('fillblankOptions').style.display = 'none';

            // Show the selected one
            switch(questionType) {
                case 'mcq':
                    document.getElementById('mcqOptions').style.display = 'block';
                    break;
                case 'poll':
                    document.getElementById('pollOptions').style.display = 'block';
                    break;
                case 'tf':
                    document.getElementById('tfOptions').style.display = 'block';
                    break;
                case 'matching':
                    document.getElementById('matchingOptions').style.display = 'block';
                    break;
                case 'ordering':
                    document.getElementById('orderingOptions').style.display = 'block';
                    break;
                case 'fillblank':
                    document.getElementById('fillblankOptions').style.display = 'block';
                    break;
            }
        }

        function addQuestion() {
            const questionType = document.getElementById('questionType').value;
            const questionText = document.getElementById('questionText').value.trim();

            if (!questionText) {
                toast.error('Please enter a question');
                return;
            }

            let question = {
                questionText: questionText,
                questionType: questionType,
                points: 10  // Default points
            };

            // Validate and add question-specific data
            try {
                switch(questionType) {
                    case 'mcq':
                        const options = [];
                        let correctAnswer = null;

                        // Iterate through all MCQ options dynamically
                        for (let i = 0; i < mcqOptionCount; i++) {
                            const letter = String.fromCharCode(65 + i);
                            const optionInput = document.getElementById(`option${letter}`);
                            if (optionInput && optionInput.value.trim()) {
                                options.push(optionInput.value.trim());
                                const radioButton = document.querySelector(`input[name="correctAnswer"][value="${letter}"]`);
                                if (radioButton && radioButton.checked) {
                                    correctAnswer = letter;
                                }
                            }
                        }

                        if (options.length < 2) {
                            toast.error('Please provide at least 2 answer options');
                            return;
                        }

                        question.options = options;
                        question.correctAnswer = correctAnswer;
                        break;

                    case 'poll':
                        const pollOptions = [];

                        // Iterate through all poll options dynamically
                        for (let i = 0; i < pollOptionCount; i++) {
                            const letter = String.fromCharCode(65 + i);
                            const pollOptionInput = document.getElementById(`pollOption${letter}`);
                            if (pollOptionInput && pollOptionInput.value.trim()) {
                                pollOptions.push(pollOptionInput.value.trim());
                            }
                        }

                        if (pollOptions.length < 2) {
                            toast.error('Please provide at least 2 poll options');
                            return;
                        }

                        question.options = pollOptions;
                        // Check if participation points should be awarded
                        const awardParticipationPoints = document.getElementById('pollParticipationPoints').checked;
                        question.awardParticipationPoints = awardParticipationPoints;
                        // No correctAnswer for polls (unless participation points enabled)
                        break;

                    case 'tf':
                        question.options = ['True', 'False'];
                        question.correctAnswer = document.querySelector('input[name="tfAnswer"]:checked').value;
                        break;

                    case 'matching':
                        const pairs = [];
                        for (let i = 1; i <= matchingPairCount; i++) {
                            const left = document.getElementById(`match${i}Left`).value.trim();
                            const right = document.getElementById(`match${i}Right`).value.trim();
                            if (left && right) {
                                pairs.push({ left, right });
                            }
                        }

                        if (pairs.length < 2) {
                            toast.error('Please provide at least 2 matching pairs');
                            return;
                        }

                        question.pairs = pairs;
                        break;

                    case 'ordering':
                        const items = [];
                        for (let i = 1; i <= orderingItemCount; i++) {
                            const item = document.getElementById(`order${i}`).value.trim();
                            if (item) {
                                items.push(item);
                            }
                        }

                        if (items.length < 2) {
                            toast.error('Please provide at least 2 items to order');
                            return;
                        }

                        question.correctOrder = items;
                        break;

                    case 'fillblank':
                        const blankAnswer = document.getElementById('blankAnswer').value.trim();
                        if (!blankAnswer) {
                            toast.error('Please provide the correct answer');
                            return;
                        }

                        if (!questionText.includes('[blank]')) {
                            toast.error('Please include [blank] in your question where the answer should go');
                            return;
                        }

                        question.correctAnswer = blankAnswer;
                        break;
                }

                // Check if editing or adding
                if (editingQuestionIndex !== null) {
                    // Update existing question
                    quizQuestions[editingQuestionIndex] = question;
                    toast.success('Question updated successfully!');
                    editingQuestionIndex = null;

                    // Reset button text
                    const addButton = document.querySelector('button[onclick="addQuestion()"]');
                    if (addButton) {
                        addButton.textContent = '+ Add This Question';
                        addButton.className = 'btn btn-primary';
                    }
                } else {
                    // Add new question to array
                    quizQuestions.push(question);
                    toast.success('Question added successfully!');
                }

                // Clear form
                clearQuestionForm();

                // Render questions list
                renderQuestionsList();

            } catch (error) {
                logger.error('Error adding question:', error);
                toast.error('Error adding question: ' + error.message);
            }
        }

        function clearQuestionForm() {
            document.getElementById('questionText').value = '';

            // Clear MCQ options (dynamic count)
            for (let i = 0; i < mcqOptionCount; i++) {
                const letter = String.fromCharCode(65 + i);
                const input = document.getElementById(`option${letter}`);
                if (input) input.value = '';
            }

            // Clear Poll options (dynamic count)
            for (let i = 0; i < pollOptionCount; i++) {
                const letter = String.fromCharCode(65 + i);
                const pollInput = document.getElementById(`pollOption${letter}`);
                if (pollInput) pollInput.value = '';
            }

            // Clear Matching pairs (dynamic count)
            for (let i = 1; i <= matchingPairCount; i++) {
                const matchLeft = document.getElementById(`match${i}Left`);
                const matchRight = document.getElementById(`match${i}Right`);
                if (matchLeft) matchLeft.value = '';
                if (matchRight) matchRight.value = '';
            }

            // Clear Ordering items (dynamic count)
            for (let i = 1; i <= orderingItemCount; i++) {
                const order = document.getElementById(`order${i}`);
                if (order) order.value = '';
            }

            const blankAnswer = document.getElementById('blankAnswer');
            if (blankAnswer) blankAnswer.value = '';
        }

        function editQuestion(index) {
            const question = quizQuestions[index];
            editingQuestionIndex = index;

            // Load question text
            document.getElementById('questionText').value = question.questionText;

            // Set question type
            document.getElementById('questionType').value = question.questionType;
            updateQuestionOptions(); // Show correct options for this type

            // Load type-specific data
            switch(question.questionType) {
                case 'mcq':
                    if (question.options) {
                        // Initialize with correct number of options
                        initializeMcqOptions(question.options.length);

                        // Then populate values
                        question.options.forEach((opt, i) => {
                            const letter = String.fromCharCode(65 + i);
                            const input = document.getElementById(`option${letter}`);
                            if (input) input.value = opt;
                        });

                        // Set correct answer
                        if (question.correctAnswer) {
                            const radio = document.querySelector(`input[name="correctAnswer"][value="${question.correctAnswer}"]`);
                            if (radio) radio.checked = true;
                        }
                    }
                    break;

                case 'poll':
                    if (question.options) {
                        // Initialize with correct number of options
                        initializePollOptions(question.options.length);

                        // Then populate values
                        question.options.forEach((opt, i) => {
                            const letter = String.fromCharCode(65 + i);
                            const input = document.getElementById(`pollOption${letter}`);
                            if (input) input.value = opt;
                        });
                    }
                    break;

                case 'tf':
                    if (question.correctAnswer) {
                        const radio = document.querySelector(`input[name="tfAnswer"][value="${question.correctAnswer}"]`);
                        if (radio) radio.checked = true;
                    }
                    break;

                case 'matching':
                    if (question.pairs) {
                        // Initialize with the right number of pairs
                        initializeMatchingPairs(question.pairs.length);
                        question.pairs.forEach((pair, i) => {
                            const num = i + 1;
                            const leftInput = document.getElementById(`match${num}Left`);
                            const rightInput = document.getElementById(`match${num}Right`);
                            if (leftInput) leftInput.value = pair.left;
                            if (rightInput) rightInput.value = pair.right;
                        });
                    }
                    break;

                case 'ordering':
                    if (question.correctOrder) {
                        // Initialize with the right number of items
                        initializeOrderingItems(question.correctOrder.length);
                        question.correctOrder.forEach((item, i) => {
                            const input = document.getElementById(`order${i + 1}`);
                            if (input) input.value = item;
                        });
                    }
                    break;

                case 'fillblank':
                    if (question.correctAnswer) {
                        document.getElementById('blankAnswer').value = question.correctAnswer;
                    }
                    break;
            }

            // Update button text
            const addButton = document.querySelector('button[onclick="addQuestion()"]');
            if (addButton) {
                addButton.textContent = 'Update Question';
                addButton.className = 'btn btn-success';
            }

            // Show cancel button
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) {
                cancelBtn.style.display = 'inline-block';
            }

            // Scroll to form
            document.getElementById('questionText').scrollIntoView({ behavior: 'smooth', block: 'center' });
            toast.success('Question loaded for editing');
        }

        function removeQuestion(index) {
            if (window.confirm('Remove this question?')) {
                quizQuestions.splice(index, 1);
                renderQuestionsList();

                // If we were editing this question, clear the edit state
                if (editingQuestionIndex === index) {
                    cancelEditQuestion();
                }

                toast.success('Question removed');
            }
        }

        function cancelEditQuestion() {
            editingQuestionIndex = null;
            clearQuestionForm();

            // Reset button text
            const addButton = document.querySelector('button[onclick="addQuestion()"]');
            if (addButton) {
                addButton.textContent = '+ Add This Question';
                addButton.className = 'btn btn-primary';
            }

            // Hide cancel button
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) {
                cancelBtn.style.display = 'none';
            }

            toast.success('Edit cancelled');
        }

        function renderQuestionsList() {
            const container = document.getElementById('questionsList');

            if (quizQuestions.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); font-size: 14px;">No questions added yet.</p>';
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 12px;">
                    <strong>${quizQuestions.length} Question(s) Added:</strong>
                </div>
                ${quizQuestions.map((q, index) => `
                    <div style="background-color: #F9FAFB; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; margin-bottom: 4px;">Q${index + 1}: ${q.questionText}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Type: ${getQuestionTypeLabel(q.questionType)}</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button type="button" class="btn btn-secondary btn-small" onclick="editQuestion(${index})">Edit</button>
                            <button type="button" class="btn btn-danger btn-small" onclick="removeQuestion(${index})">Remove</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function getQuestionTypeLabel(type) {
            const labels = {
                'mcq': 'Multiple Choice',
                'poll': 'Poll',
                'tf': 'True/False',
                'matching': 'Matching',
                'ordering': 'Put in Order',
                'fillblank': 'Fill in the Blank'
            };
            return labels[type] || type.toUpperCase();
        }

        async function handleSaveQuiz(e) {
            e.preventDefault();

            const title = document.getElementById('quizTitle').value.trim();
            const description = document.getElementById('quizDescription').value.trim();

            if (!title) {
                toast.error('Please enter a quiz title');
                return;
            }

            if (quizQuestions.length === 0) {
                toast.error('Please add at least one question to the quiz');
                return;
            }

            // Transform questions to match backend schema
            const questions = quizQuestions.map(q => ({
                questionSnapshot: {
                    questionText: q.questionText,
                    questionType: q.questionType,
                    options: q.options,
                    correctAnswer: q.correctAnswer,
                    pairs: q.pairs,
                    correctOrder: q.correctOrder
                },
                points: q.points || 10
            }));

            const quizData = {
                title,
                description,
                type: 'standard',
                questions,
                questionCount: questions.length,
                settings: {
                    shuffleQuestions: false,
                    shuffleAnswers: false,
                    showCorrectAnswers: true
                }
            };

            try {
                document.getElementById('saveButton').disabled = true;
                document.getElementById('saveButton').textContent = 'Saving...';

                let result;
                if (editingQuizId) {
                    // Update existing quiz
                    result = await quizzes.update(editingQuizId, quizData);
                    logger.debug('Quiz updated:', result);
                    toast.success('Quiz updated successfully!');
                } else {
                    // Create new quiz
                    result = await quizzes.create(quizData);
                    logger.debug('Quiz created:', result);
                    toast.success('Quiz saved successfully!');
                }

                // Redirect to quizzes page
                setTimeout(() => {
                    window.location.href = 'quizzes.html';
                }, 1000);

            } catch (error) {
                logger.error('Error saving quiz:', error);
                toast.error('Failed to save quiz: ' + error.message);
                document.getElementById('saveButton').disabled = false;
                document.getElementById('saveButton').textContent = 'Save Quiz';
            }
        }

        function cancelQuiz() {
            if (quizQuestions.length > 0) {
                if (window.confirm('Are you sure you want to cancel? All unsaved changes will be lost.')) {
                    window.location.href = 'quizzes.html';
                }
            } else {
                window.location.href = 'quizzes.html';
            }
        }

        function insertBlank() {
            const textarea = document.getElementById('questionText');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;

            // Insert [blank] at cursor position
            const newText = text.substring(0, start) + '[blank]' + text.substring(end);
            textarea.value = newText;

            // Move cursor after [blank]
            textarea.selectionStart = textarea.selectionEnd = start + 7;
            textarea.focus();
        }

        // Expose functions to window for onclick handlers
        window.updateQuestionOptions = updateQuestionOptions;
        window.addQuestion = addQuestion;
        window.editQuestion = editQuestion;
        window.removeQuestion = removeQuestion;
        window.cancelEditQuestion = cancelEditQuestion;
        window.cancelQuiz = cancelQuiz;
        window.insertBlank = insertBlank;
        window.addMcqOption = addMcqOption;
        window.removeMcqOption = removeMcqOption;
        window.addPollOption = addPollOption;
        window.removePollOption = removePollOption;
        window.addMatchingPair = addMatchingPair;
        window.removeMatchingPair = removeMatchingPair;
        window.addOrderingItem = addOrderingItem;
        window.removeOrderingItem = removeOrderingItem;
    </script>
</body>
</html>
