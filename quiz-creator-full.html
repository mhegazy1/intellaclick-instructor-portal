<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Quiz - IntellaClick</title>
    <link rel="stylesheet" href="styles/common.css">
    <link rel="stylesheet" href="styles/create-session.css">
</head>
<body>
    <div class="container">
        <a href="quizzes.html" class="back-link">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Quizzes
        </a>

        <div class="header">
            <h1>Create New Quiz</h1>
        </div>

        <div class="section">
            <h2>Quiz Information</h2>
            <form id="quizForm">
                <div class="form-group">
                    <label for="quizTitle">Quiz Title *</label>
                    <input type="text" id="quizTitle" placeholder="e.g., Chapter 3 Quiz" required>
                </div>

                <div class="form-group">
                    <label for="quizDescription">Description (Optional)</label>
                    <textarea id="quizDescription" rows="3" placeholder="Brief description of the quiz"></textarea>
                </div>

                <!-- Questions Section -->
                <div class="form-group">
                    <hr style="margin: 24px 0; border: none; border-top: 1px solid #e0e0e0;">
                    <h2 style="margin-bottom: 16px;">Quiz Questions</h2>

                    <!-- Questions List -->
                    <div id="questionsList" style="margin-bottom: 20px;"></div>

                    <label for="questionText">Add Question *</label>
                    <textarea id="questionText" rows="3" placeholder="Enter your question here..."></textarea>
                    <button type="button" class="btn btn-secondary" onclick="insertBlank()" style="margin-top: 8px; font-size: 0.9rem; padding: 0.5rem 1rem;">
                        Insert [blank] at cursor
                    </button>

                    <label style="margin-top: 16px;">Question Type</label>
                    <select id="questionType" onchange="updateQuestionOptions()">
                        <option value="mcq">Multiple Choice</option>
                        <option value="poll">Poll (No Correct Answer)</option>
                        <option value="tf">True/False</option>
                        <option value="matching">Matching</option>
                        <option value="ordering">Put in Order</option>
                        <option value="fillblank">Fill in the Blank</option>
                    </select>

                    <!-- Multiple Choice Options -->
                    <div id="mcqOptions" style="margin-top: 16px;">
                        <label>Answer Options</label>
                        <div class="radio-group" style="flex-direction: column; gap: 10px;">
                            <div class="radio-option">
                                <input type="radio" name="correctAnswer" value="A" checked>
                                <input type="text" id="optionA" placeholder="Option A" style="width: calc(100% - 40px); margin-left: 8px;">
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="correctAnswer" value="B">
                                <input type="text" id="optionB" placeholder="Option B" style="width: calc(100% - 40px); margin-left: 8px;">
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="correctAnswer" value="C">
                                <input type="text" id="optionC" placeholder="Option C" style="width: calc(100% - 40px); margin-left: 8px;">
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="correctAnswer" value="D">
                                <input type="text" id="optionD" placeholder="Option D" style="width: calc(100% - 40px); margin-left: 8px;">
                            </div>
                        </div>
                        <small style="color: var(--text-secondary); margin-top: 8px; display: block;">Select the radio button next to the correct answer</small>
                    </div>

                    <!-- Poll Options (No Correct Answer) -->
                    <div id="pollOptions" style="margin-top: 16px; display: none;">
                        <label>Poll Options</label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <input type="text" id="pollOptionA" placeholder="Option A" style="width: 100%;">
                            <input type="text" id="pollOptionB" placeholder="Option B" style="width: 100%;">
                            <input type="text" id="pollOptionC" placeholder="Option C" style="width: 100%;">
                            <input type="text" id="pollOptionD" placeholder="Option D" style="width: 100%;">
                        </div>
                        <small style="color: var(--text-secondary); margin-top: 8px; display: block;">No correct answer - results will show distribution</small>
                    </div>

                    <!-- True/False Options -->
                    <div id="tfOptions" style="margin-top: 16px; display: none;">
                        <label>Correct Answer</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" name="tfAnswer" value="true" checked>
                                <label>True</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="tfAnswer" value="false">
                                <label>False</label>
                            </div>
                        </div>
                    </div>

                    <!-- Matching Options -->
                    <div id="matchingOptions" style="margin-top: 16px; display: none;">
                        <label>Matching Pairs</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px;">
                            <input type="text" id="match1Left" placeholder="Item 1">
                            <input type="text" id="match1Right" placeholder="Match 1">
                            <input type="text" id="match2Left" placeholder="Item 2">
                            <input type="text" id="match2Right" placeholder="Match 2">
                            <input type="text" id="match3Left" placeholder="Item 3">
                            <input type="text" id="match3Right" placeholder="Match 3">
                            <input type="text" id="match4Left" placeholder="Item 4">
                            <input type="text" id="match4Right" placeholder="Match 4">
                        </div>
                    </div>

                    <!-- Ordering Options -->
                    <div id="orderingOptions" style="margin-top: 16px; display: none;">
                        <label>Items in Correct Order</label>
                        <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
                            <input type="text" id="order1" placeholder="1st item">
                            <input type="text" id="order2" placeholder="2nd item">
                            <input type="text" id="order3" placeholder="3rd item">
                            <input type="text" id="order4" placeholder="4th item">
                        </div>
                        <small style="color: var(--text-secondary); margin-top: 8px; display: block;">Enter items in the correct order</small>
                    </div>

                    <!-- Fill in the Blank Options -->
                    <div id="fillblankOptions" style="margin-top: 16px; display: none;">
                        <label>Correct Answer(s)</label>
                        <input type="text" id="blankAnswer" placeholder="Enter the correct answer" style="margin-top: 8px;">
                        <small style="color: var(--text-secondary); margin-top: 8px; display: block;">Use [blank] in your question text where the answer should go</small>
                    </div>

                    <!-- Add Question Button -->
                    <div style="margin-top: 16px;">
                        <button type="button" class="btn btn-primary" onclick="addQuestion()">+ Add This Question</button>
                    </div>
                </div>

                <div class="btn-group" style="margin-top: 32px;">
                    <button type="button" class="btn btn-secondary" onclick="cancelQuiz()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveButton">Save Quiz</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script type="module">
        import { quizzes } from './utils/api.js';
        import toast from './utils/toast.js';
        import logger from './utils/logger.js';

        let quizQuestions = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            document.getElementById('quizForm').addEventListener('submit', handleSaveQuiz);
            updateQuestionOptions(); // Show default MCQ options
        });

        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
            }
        }

        function updateQuestionOptions() {
            const questionType = document.getElementById('questionType').value;

            // Hide all option divs
            document.getElementById('mcqOptions').style.display = 'none';
            document.getElementById('pollOptions').style.display = 'none';
            document.getElementById('tfOptions').style.display = 'none';
            document.getElementById('matchingOptions').style.display = 'none';
            document.getElementById('orderingOptions').style.display = 'none';
            document.getElementById('fillblankOptions').style.display = 'none';

            // Show the selected one
            switch(questionType) {
                case 'mcq':
                    document.getElementById('mcqOptions').style.display = 'block';
                    break;
                case 'poll':
                    document.getElementById('pollOptions').style.display = 'block';
                    break;
                case 'tf':
                    document.getElementById('tfOptions').style.display = 'block';
                    break;
                case 'matching':
                    document.getElementById('matchingOptions').style.display = 'block';
                    break;
                case 'ordering':
                    document.getElementById('orderingOptions').style.display = 'block';
                    break;
                case 'fillblank':
                    document.getElementById('fillblankOptions').style.display = 'block';
                    break;
            }
        }

        function addQuestion() {
            const questionType = document.getElementById('questionType').value;
            const questionText = document.getElementById('questionText').value.trim();

            if (!questionText) {
                toast.error('Please enter a question');
                return;
            }

            let question = {
                questionText: questionText,
                questionType: questionType,
                points: 10  // Default points
            };

            // Validate and add question-specific data
            try {
                switch(questionType) {
                    case 'mcq':
                        const options = [];
                        let correctAnswer = null;

                        ['A', 'B', 'C', 'D'].forEach(letter => {
                            const optionInput = document.getElementById(`option${letter}`);
                            if (optionInput && optionInput.value.trim()) {
                                options.push(optionInput.value.trim());
                                const radioButton = document.querySelector(`input[name="correctAnswer"][value="${letter}"]`);
                                if (radioButton && radioButton.checked) {
                                    correctAnswer = letter;
                                }
                            }
                        });

                        if (options.length < 2) {
                            toast.error('Please provide at least 2 answer options');
                            return;
                        }

                        question.options = options;
                        question.correctAnswer = correctAnswer;
                        break;

                    case 'poll':
                        const pollOptions = [];

                        ['A', 'B', 'C', 'D'].forEach(letter => {
                            const pollOptionInput = document.getElementById(`pollOption${letter}`);
                            if (pollOptionInput && pollOptionInput.value.trim()) {
                                pollOptions.push(pollOptionInput.value.trim());
                            }
                        });

                        if (pollOptions.length < 2) {
                            toast.error('Please provide at least 2 poll options');
                            return;
                        }

                        question.options = pollOptions;
                        // No correctAnswer for polls
                        break;

                    case 'tf':
                        question.options = ['True', 'False'];
                        question.correctAnswer = document.querySelector('input[name="tfAnswer"]:checked').value;
                        break;

                    case 'matching':
                        const pairs = [];
                        for (let i = 1; i <= 4; i++) {
                            const left = document.getElementById(`match${i}Left`).value.trim();
                            const right = document.getElementById(`match${i}Right`).value.trim();
                            if (left && right) {
                                pairs.push({ left, right });
                            }
                        }

                        if (pairs.length < 2) {
                            toast.error('Please provide at least 2 matching pairs');
                            return;
                        }

                        question.pairs = pairs;
                        break;

                    case 'ordering':
                        const items = [];
                        for (let i = 1; i <= 4; i++) {
                            const item = document.getElementById(`order${i}`).value.trim();
                            if (item) {
                                items.push(item);
                            }
                        }

                        if (items.length < 2) {
                            toast.error('Please provide at least 2 items to order');
                            return;
                        }

                        question.correctOrder = items;
                        break;

                    case 'fillblank':
                        const blankAnswer = document.getElementById('blankAnswer').value.trim();
                        if (!blankAnswer) {
                            toast.error('Please provide the correct answer');
                            return;
                        }

                        if (!questionText.includes('[blank]')) {
                            toast.error('Please include [blank] in your question where the answer should go');
                            return;
                        }

                        question.correctAnswer = blankAnswer;
                        break;
                }

                // Add question to array
                quizQuestions.push(question);

                // Clear form
                clearQuestionForm();

                // Render questions list
                renderQuestionsList();

                toast.success('Question added successfully!');

            } catch (error) {
                logger.error('Error adding question:', error);
                toast.error('Error adding question: ' + error.message);
            }
        }

        function clearQuestionForm() {
            document.getElementById('questionText').value = '';
            ['A', 'B', 'C', 'D'].forEach(letter => {
                const input = document.getElementById(`option${letter}`);
                if (input) input.value = '';
                const pollInput = document.getElementById(`pollOption${letter}`);
                if (pollInput) pollInput.value = '';
            });
            for (let i = 1; i <= 4; i++) {
                const matchLeft = document.getElementById(`match${i}Left`);
                const matchRight = document.getElementById(`match${i}Right`);
                const order = document.getElementById(`order${i}`);
                if (matchLeft) matchLeft.value = '';
                if (matchRight) matchRight.value = '';
                if (order) order.value = '';
            }
            const blankAnswer = document.getElementById('blankAnswer');
            if (blankAnswer) blankAnswer.value = '';
        }

        function removeQuestion(index) {
            if (window.confirm('Remove this question?')) {
                quizQuestions.splice(index, 1);
                renderQuestionsList();
                toast.success('Question removed');
            }
        }

        function renderQuestionsList() {
            const container = document.getElementById('questionsList');

            if (quizQuestions.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); font-size: 14px;">No questions added yet.</p>';
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 12px;">
                    <strong>${quizQuestions.length} Question(s) Added:</strong>
                </div>
                ${quizQuestions.map((q, index) => `
                    <div style="background-color: #F9FAFB; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; margin-bottom: 4px;">Q${index + 1}: ${q.questionText}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Type: ${getQuestionTypeLabel(q.questionType)}</div>
                        </div>
                        <button type="button" class="btn btn-danger btn-small" onclick="removeQuestion(${index})" style="margin-left: 12px;">Remove</button>
                    </div>
                `).join('')}
            `;
        }

        function getQuestionTypeLabel(type) {
            const labels = {
                'mcq': 'Multiple Choice',
                'poll': 'Poll',
                'tf': 'True/False',
                'matching': 'Matching',
                'ordering': 'Put in Order',
                'fillblank': 'Fill in the Blank'
            };
            return labels[type] || type.toUpperCase();
        }

        async function handleSaveQuiz(e) {
            e.preventDefault();

            const title = document.getElementById('quizTitle').value.trim();
            const description = document.getElementById('quizDescription').value.trim();

            if (!title) {
                toast.error('Please enter a quiz title');
                return;
            }

            if (quizQuestions.length === 0) {
                toast.error('Please add at least one question to the quiz');
                return;
            }

            // Transform questions to match backend schema
            const questions = quizQuestions.map(q => ({
                questionSnapshot: {
                    questionText: q.questionText,
                    questionType: q.questionType,
                    options: q.options,
                    correctAnswer: q.correctAnswer,
                    pairs: q.pairs,
                    correctOrder: q.correctOrder
                },
                points: q.points || 10
            }));

            const quizData = {
                title,
                description,
                type: 'standard',
                questions,
                questionCount: questions.length,
                settings: {
                    shuffleQuestions: false,
                    shuffleAnswers: false,
                    showCorrectAnswers: true
                }
            };

            try {
                document.getElementById('saveButton').disabled = true;
                document.getElementById('saveButton').textContent = 'Saving...';

                const result = await quizzes.create(quizData);
                logger.debug('Quiz created:', result);

                toast.success('Quiz saved successfully!');

                // Redirect to quizzes page
                setTimeout(() => {
                    window.location.href = 'quizzes.html';
                }, 1000);

            } catch (error) {
                logger.error('Error saving quiz:', error);
                toast.error('Failed to save quiz: ' + error.message);
                document.getElementById('saveButton').disabled = false;
                document.getElementById('saveButton').textContent = 'Save Quiz';
            }
        }

        function cancelQuiz() {
            if (quizQuestions.length > 0) {
                if (window.confirm('Are you sure you want to cancel? All unsaved changes will be lost.')) {
                    window.location.href = 'quizzes.html';
                }
            } else {
                window.location.href = 'quizzes.html';
            }
        }

        function insertBlank() {
            const textarea = document.getElementById('questionText');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;

            // Insert [blank] at cursor position
            const newText = text.substring(0, start) + '[blank]' + text.substring(end);
            textarea.value = newText;

            // Move cursor after [blank]
            textarea.selectionStart = textarea.selectionEnd = start + 7;
            textarea.focus();
        }

        // Expose functions to window for onclick handlers
        window.updateQuestionOptions = updateQuestionOptions;
        window.addQuestion = addQuestion;
        window.removeQuestion = removeQuestion;
        window.cancelQuiz = cancelQuiz;
        window.insertBlank = insertBlank;
    </script>
</body>
</html>
