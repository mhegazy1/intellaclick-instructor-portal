<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Management - IntellaClick</title>
    <style>
        :root {
            --primary-color: #4F46E5;
            --primary-hover: #4338CA;
            --secondary-color: #10B981;
            --danger-color: #EF4444;
            --warning-color: #F59E0B;
            --background: #F9FAFB;
            --surface: #FFFFFF;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --border: #E5E7EB;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background-color: var(--surface);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .session-info {
            display: flex;
            gap: 24px;
            margin-top: 16px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .info-value {
            font-size: 18px;
            font-weight: 600;
        }

        .session-code {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary-color);
            letter-spacing: 2px;
        }

        .join-url {
            background-color: #EFF6FF;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 16px;
            font-family: monospace;
            font-size: 14px;
        }

        .section {
            background-color: var(--surface);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .section h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            margin: 4px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        .btn-secondary {
            background-color: #F3F4F6;
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background-color: #E5E7EB;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #DC2626;
        }

        .btn-success {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #059669;
        }

        .participants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .participant-card {
            background-color: var(--background);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .responses-section {
            margin-top: 20px;
        }

        .response-chart {
            height: 300px;
            background-color: var(--background);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .control-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-waiting {
            background-color: #FEF3C7;
            color: #92400E;
        }

        .status-active {
            background-color: #D1FAE5;
            color: #065F46;
        }

        .status-ended {
            background-color: #FEE2E2;
            color: #991B1B;
        }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            background-color: var(--surface);
            border-radius: 8px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid var(--secondary-color);
        }

        .toast.error {
            border-left: 4px solid var(--danger-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Session Management</h1>
            <div class="session-info">
                <div class="info-item">
                    <span class="info-label">Session Code</span>
                    <span class="session-code" id="sessionCode">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Status</span>
                    <span class="status-badge status-waiting" id="sessionStatus">Waiting</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Participants</span>
                    <span class="info-value" id="participantCount">0</span>
                </div>
            </div>
            <div class="join-url" id="joinUrl">
                Students can join at: https://join.intellaclick.com/session/XXXXX
            </div>
        </div>

        <div class="section" id="questionSection">
            <h2>Current Question</h2>
            <p id="questionStatus">No question active. Click "Send Question" to start.</p>
            <div id="questionDisplay" style="display: none;">
                <h3 id="questionText"></h3>
                <div id="questionOptions"></div>
            </div>
            <div class="control-buttons">
                <button class="btn btn-primary" onclick="sendQuestion()">Send Question</button>
                <button class="btn btn-secondary" onclick="stopQuestion()" disabled id="stopBtn">Stop Question</button>
                <button class="btn btn-success" onclick="showResults()" disabled id="resultsBtn">Show Results</button>
            </div>
        </div>

        <div class="section">
            <h2>Participants</h2>
            <div id="participantsList" class="participants-grid">
                <p style="color: var(--text-secondary);">No participants yet. Share the session code for students to join.</p>
            </div>
        </div>

        <div class="section" id="responsesSection" style="display: none;">
            <h2>Responses</h2>
            <div class="response-chart" id="responseChart">
                Response data will appear here
            </div>
        </div>

        <div class="control-buttons">
            <button class="btn btn-danger" onclick="endSession()">End Session</button>
            <a href="/classes.html" class="btn btn-secondary">Back to Classes</a>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        let sessionId;
        let sessionCode;
        let sessionData;
        let pendingQuestion;
        let pollInterval;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            sessionId = urlParams.get('id');
            sessionCode = urlParams.get('code');
            const sessionType = urlParams.get('type');
            
            if (!sessionId || !sessionCode) {
                showToast('Invalid session parameters', 'error');
                setTimeout(() => window.location.href = '/classes.html', 2000);
                return;
            }

            // Check for pending question from create-session page
            const questionData = sessionStorage.getItem('pendingQuestion');
            if (questionData) {
                pendingQuestion = JSON.parse(questionData);
                sessionStorage.removeItem('pendingQuestion');
            }

            checkAuth();
            loadSession();
            startPolling();
        });

        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
            }
        }

        async function loadSession() {
            try {
                const response = await fetch(`https://api.intellaclick.com/api/sessions/code/${sessionCode}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load session');

                const data = await response.json();
                sessionData = data.session;
                
                updateSessionDisplay();
            } catch (error) {
                console.error('Error loading session:', error);
                showToast('Failed to load session', 'error');
            }
        }

        function updateSessionDisplay() {
            document.getElementById('sessionCode').textContent = sessionData.sessionCode;
            document.getElementById('participantCount').textContent = sessionData.participantCount || 0;
            document.getElementById('joinUrl').textContent = `Students can join at: https://join.intellaclick.com/session/${sessionData.sessionCode}`;
            
            // Update status badge
            const statusEl = document.getElementById('sessionStatus');
            statusEl.textContent = sessionData.status.charAt(0).toUpperCase() + sessionData.status.slice(1);
            statusEl.className = `status-badge status-${sessionData.status}`;
            
            // Update button states
            if (sessionData.status === 'active' && sessionData.currentQuestion) {
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('resultsBtn').disabled = false;
                displayCurrentQuestion(sessionData.currentQuestion);
            }
        }

        async function sendQuestion() {
            if (!pendingQuestion) {
                showToast('No question prepared. Please create a question first.', 'error');
                return;
            }

            try {
                const response = await fetch(`https://api.intellaclick.com/api/sessions/${sessionId}/send-question`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        question: pendingQuestion
                    })
                });

                if (!response.ok) throw new Error('Failed to send question');

                showToast('Question sent successfully!', 'success');
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('resultsBtn').disabled = false;
                
                // Reload session to get updated state
                await loadSession();
            } catch (error) {
                console.error('Error sending question:', error);
                showToast('Failed to send question', 'error');
            }
        }

        function displayCurrentQuestion(question) {
            document.getElementById('questionStatus').style.display = 'none';
            document.getElementById('questionDisplay').style.display = 'block';
            document.getElementById('questionText').textContent = question.questionText || question.text;
            
            // Display options based on question type
            const optionsDiv = document.getElementById('questionOptions');
            optionsDiv.innerHTML = '';
            
            if (question.options) {
                question.options.forEach((option, index) => {
                    const optionEl = document.createElement('div');
                    optionEl.style.marginTop = '8px';
                    optionEl.textContent = `${option}: ${question.optionTexts ? question.optionTexts[index] : ''}`;
                    optionsDiv.appendChild(optionEl);
                });
            }
        }

        async function stopQuestion() {
            try {
                const response = await fetch(`https://api.intellaclick.com/api/sessions/${sessionId}/stop-question`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Failed to stop question');

                showToast('Question stopped', 'success');
                await loadSession();
            } catch (error) {
                console.error('Error stopping question:', error);
                showToast('Failed to stop question', 'error');
            }
        }

        async function showResults() {
            document.getElementById('responsesSection').style.display = 'block';
            // TODO: Implement results display
            showToast('Results feature coming soon', 'info');
        }

        async function endSession() {
            if (!confirm('Are you sure you want to end this session?')) return;

            try {
                const response = await fetch(`https://api.intellaclick.com/api/sessions/${sessionId}/end`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Failed to end session');

                showToast('Session ended', 'success');
                stopPolling();
                setTimeout(() => window.location.href = '/classes.html', 2000);
            } catch (error) {
                console.error('Error ending session:', error);
                showToast('Failed to end session', 'error');
            }
        }

        function startPolling() {
            // Poll for updates every 3 seconds
            pollInterval = setInterval(loadSession, 3000);
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', stopPolling);
    </script>
</body>
</html>