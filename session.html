<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Management - IntellaClick</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        :root {
            --primary-color: #4F46E5;
            --primary-hover: #4338CA;
            --secondary-color: #10B981;
            --danger-color: #EF4444;
            --warning-color: #F59E0B;
            --background: #F9FAFB;
            --surface: #FFFFFF;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --border: #E5E7EB;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background-color: var(--surface);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .session-info {
            display: flex;
            gap: 24px;
            margin-top: 16px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .info-value {
            font-size: 18px;
            font-weight: 600;
        }

        .session-code {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary-color);
            letter-spacing: 2px;
        }

        .join-url {
            background-color: #EFF6FF;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 16px;
            font-family: monospace;
            font-size: 14px;
        }

        .section {
            background-color: var(--surface);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .section h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            margin: 4px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        .btn-secondary {
            background-color: #F3F4F6;
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background-color: #E5E7EB;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #DC2626;
        }

        .btn-success {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #059669;
        }

        .participants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .participant-card {
            background-color: var(--background);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .responses-section {
            margin-top: 20px;
        }

        .response-chart {
            height: 300px;
            background-color: var(--background);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .control-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-waiting {
            background-color: #FEF3C7;
            color: #92400E;
        }

        .status-active {
            background-color: #D1FAE5;
            color: #065F46;
        }

        .status-ended {
            background-color: #FEE2E2;
            color: #991B1B;
        }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            background-color: var(--surface);
            border-radius: 8px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid var(--secondary-color);
        }

        .toast.error {
            border-left: 4px solid var(--danger-color);
        }

        .qr-container {
            display: flex;
            align-items: center;
            gap: 24px;
            margin-top: 20px;
            padding: 20px;
            background-color: var(--background);
            border-radius: 8px;
        }

        .qr-code {
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .qr-info {
            flex: 1;
        }

        .qr-info h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .qr-info p {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .qr-container {
                flex-direction: column;
                text-align: center;
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }

        .modal-content {
            background-color: var(--surface);
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .modal-body {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .close {
            float: right;
            font-size: 24px;
            font-weight: bold;
            line-height: 24px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .close:hover {
            color: var(--text-primary);
        }

        .question-item {
            background-color: var(--surface);
            border: 1px solid var(--border);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .question-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .question-item-text {
            flex: 1;
            margin-right: 12px;
        }

        .question-item-actions {
            display: flex;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .quiz-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px;
        }

        .quiz-item {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .quiz-item:hover {
            background-color: var(--background);
            border-color: var(--primary-color);
        }

        .quiz-item.selected {
            background-color: #EFF6FF;
            border-color: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Session Management</h1>
            <div class="session-info">
                <div class="info-item">
                    <span class="info-label">Session Code</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="session-code" id="sessionCode">Loading...</span>
                        <button class="btn btn-secondary" onclick="copySessionCode()" style="padding: 4px 8px; font-size: 12px;">Copy</button>
                    </div>
                </div>
                <div class="info-item">
                    <span class="info-label">Status</span>
                    <span class="status-badge status-waiting" id="sessionStatus">Waiting</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Participants</span>
                    <span class="info-value" id="participantCount">0</span>
                </div>
            </div>
            <div class="join-url" id="joinUrl">
                Students can join at: https://join.intellaclick.com/session/XXXXX
            </div>
            <div class="qr-container">
                <div class="qr-code" id="qrcode"></div>
                <div class="qr-info">
                    <h3>Scan to Join</h3>
                    <p>Students can scan this QR code with their phone to join the session instantly. The code contains the direct link to join this session.</p>
                </div>
            </div>
        </div>

        <div class="section" id="questionSection">
            <h2>Question Management</h2>
            
            <!-- Question Queue -->
            <div id="questionQueue" style="margin-bottom: 20px;">
                <h3 style="font-size: 16px; margin-bottom: 12px;">Question Queue</h3>
                <div id="queueList" style="background-color: var(--background); padding: 12px; border-radius: 8px; min-height: 60px;">
                    <p style="color: var(--text-secondary); font-size: 14px;">No questions in queue. Create a new question or import from a quiz.</p>
                </div>
            </div>

            <!-- Current Question Display -->
            <div id="currentQuestionSection" style="display: none; margin-bottom: 20px;">
                <h3 style="font-size: 16px; margin-bottom: 12px;">Current Question</h3>
                <div style="background-color: #EFF6FF; padding: 16px; border-radius: 8px;">
                    <h4 id="questionText" style="margin-bottom: 12px;"></h4>
                    <div id="questionOptions"></div>
                </div>
            </div>

            <div class="control-buttons">
                <button class="btn btn-primary" onclick="openDisplayView()" style="font-size: 1rem; font-weight: 600;">
                    <svg width="20" height="20" fill="currentColor" style="margin-right: 6px;">
                        <path d="M0 1.5A1.5 1.5 0 0 1 1.5 0h13A1.5 1.5 0 0 1 16 1.5v13a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 14.5v-13zM1.5 1a.5.5 0 0 0-.5.5v13a.5.5 0 0 0 .5.5h13a.5.5 0 0 0 .5-.5v-13a.5.5 0 0 0-.5-.5h-13z"/>
                        <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                    </svg>
                    🖥️ Open Display View
                </button>
                <button class="btn btn-primary" onclick="showQuestionModal()">
                    <svg width="16" height="16" fill="currentColor" style="margin-right: 4px;">
                        <path d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
                    </svg>
                    Create Question
                </button>
                <button class="btn btn-secondary" onclick="showImportModal()">
                    <svg width="16" height="16" fill="currentColor" style="margin-right: 4px;">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                    </svg>
                    Import Quiz
                </button>
                <button class="btn btn-success" onclick="sendNextQuestion()" disabled id="sendBtn">Next Question</button>
                <button class="btn btn-secondary" onclick="stopQuestion()" disabled id="stopBtn">Stop Question</button>
                <button class="btn btn-success" onclick="showResults()" disabled id="resultsBtn">Show Results</button>
            </div>
        </div>

        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 style="margin: 0;">Participants</h2>
                <button class="btn btn-secondary" onclick="loadSession()" style="padding: 6px 12px; font-size: 12px;">
                    Refresh
                </button>
            </div>
            <div id="participantsList" class="participants-grid">
                <p style="color: var(--text-secondary);">No participants yet. Share the session code for students to join.</p>
            </div>
        </div>

        <div class="section" id="responsesSection" style="display: none;">
            <h2>Responses</h2>
            <div class="response-chart" id="responseChart">
                Response data will appear here
            </div>
        </div>

        <div class="control-buttons">
            <button class="btn btn-danger" onclick="endSession()">End Session</button>
            <a href="/classes.html" class="btn btn-secondary">Back to Classes</a>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <!-- Create Question Modal -->
    <div id="questionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeQuestionModal()">&times;</span>
                <h2>Create Quick Question</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="modalQuestionText">Question</label>
                    <textarea id="modalQuestionText" rows="3" placeholder="Enter your question here..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="modalQuestionType">Question Type</label>
                    <select id="modalQuestionType" onchange="updateModalOptions()">
                        <option value="mcq">Multiple Choice</option>
                        <option value="tf">True/False</option>
                        <option value="matching">Matching</option>
                        <option value="ordering">Put in Order</option>
                        <option value="fillblank">Fill in the Blank</option>
                    </select>
                </div>
                
                <div id="modalQuestionOptions">
                    <!-- Options will be dynamically inserted based on question type -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeQuestionModal()">Cancel</button>
                <button class="btn btn-primary" onclick="addQuestionToQueue()">Add to Queue</button>
            </div>
        </div>
    </div>

    <!-- Import Quiz Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeImportModal()">&times;</span>
                <h2>Import Quiz Questions</h2>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px;">Select a quiz to import its questions:</p>
                <div class="quiz-list" id="quizList">
                    <p style="color: var(--text-secondary); text-align: center; padding: 20px;">Loading quizzes...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
                <button class="btn btn-primary" onclick="importSelectedQuiz()" disabled id="importBtn">Import Selected</button>
            </div>
        </div>
    </div>

    <script>
        let sessionId;
        let sessionCode;
        let sessionData;
        let classId;
        let questionQueue = [];
        let currentQuestionIndex = -1;
        let pollInterval;
        let selectedQuizId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            sessionId = urlParams.get('id');
            sessionCode = urlParams.get('code');
            const sessionType = urlParams.get('type');
            
            if (!sessionId || !sessionCode) {
                showToast('Invalid session parameters', 'error');
                setTimeout(() => window.location.href = '/classes.html', 2000);
                return;
            }

            // Check for pending question from create-session page
            // Load multiple questions from sessionStorage (new format)
            const questionsData = sessionStorage.getItem('pendingQuestions');
            if (questionsData) {
                const questions = JSON.parse(questionsData);
                questionQueue.push(...questions); // Add all questions to queue
                sessionStorage.removeItem('pendingQuestions');
                sessionStorage.removeItem('currentQuestionIndex');
                updateQueueDisplay();
            } else {
                // Fallback to single question format (legacy support)
                const questionData = sessionStorage.getItem('pendingQuestion');
                if (questionData) {
                    const question = JSON.parse(questionData);
                    questionQueue.push(question);
                    sessionStorage.removeItem('pendingQuestion');
                    updateQueueDisplay();
                }
            }

            checkAuth();
            loadSession();
            startPolling();
        });

        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
            }
        }

        async function loadSession() {
            try {
                const response = await fetch(`https://api.intellaclick.com/api/sessions/code/${sessionCode}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load session');

                const data = await response.json();
                sessionData = data.session;
                classId = sessionData.classId; // Get classId from session data
                
                console.log('Session loaded:', {
                    sessionId: sessionId,
                    sessionCode: sessionCode,
                    sessionData: sessionData,
                    hasCurrentQuestion: !!sessionData.currentQuestion
                });
                
                updateSessionDisplay();
            } catch (error) {
                console.error('Error loading session:', error);
                showToast('Failed to load session', 'error');
            }
        }

        function updateSessionDisplay() {
            document.getElementById('sessionCode').textContent = sessionData.sessionCode;
            document.getElementById('participantCount').textContent = sessionData.participantCount || 0;
            
            const joinUrl = `https://join.intellaclick.com/session/${sessionData.sessionCode}`;
            document.getElementById('joinUrl').innerHTML = `
                <strong>Students can join at:</strong><br>
                <div style="display: flex; align-items: center; gap: 12px; margin: 8px 0;">
                    <span style="font-size: 16px; user-select: all; flex: 1;">${joinUrl}</span>
                    <button class="btn btn-secondary" onclick="copyJoinUrl('${joinUrl}')" style="padding: 6px 12px; font-size: 12px;">
                        Copy Link
                    </button>
                </div>
                <small style="color: var(--text-secondary); margin-top: 4px; display: block;">
                    Session ID: ${sessionData.id || sessionData._id}<br>
                    ${sessionData.restrictToEnrolled === false ? 'Open to all students' : 'Restricted to enrolled students only'}
                </small>
            `;
            
            // Generate QR code
            generateQRCode(joinUrl);
            
            // Update status badge
            const statusEl = document.getElementById('sessionStatus');
            statusEl.textContent = sessionData.status.charAt(0).toUpperCase() + sessionData.status.slice(1);
            statusEl.className = `status-badge status-${sessionData.status}`;
            
            // Update button states
            if (sessionData.status === 'active' && sessionData.currentQuestion) {
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('resultsBtn').disabled = false;
                displayCurrentQuestion(sessionData.currentQuestion);
            }
            
            // Update participants list
            updateParticipantsList();
        }
        
        function updateParticipantsList() {
            const participantsList = document.getElementById('participantsList');
            
            // Load detailed participant info if available
            fetch(`https://api.intellaclick.com/api/sessions/${sessionId}/participants`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.participants && data.participants.length > 0) {
                    participantsList.innerHTML = '';
                    data.participants.forEach(p => {
                        const card = document.createElement('div');
                        card.className = 'participant-card';
                        card.innerHTML = `
                            <strong>${p.name || 'Anonymous'}</strong><br>
                            <small style="color: var(--text-secondary);">
                                Joined: ${new Date(p.joinedAt).toLocaleTimeString()}<br>
                                ${p.isEnrolled ? 'Enrolled Student' : 'Guest'}
                            </small>
                        `;
                        participantsList.appendChild(card);
                    });
                } else {
                    participantsList.innerHTML = '<p style="color: var(--text-secondary);">No participants yet. Share the session code for students to join.</p>';
                }
            })
            .catch(error => {
                console.error('Error loading participants:', error);
            });
        }

        function generateQRCode(url) {
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = ''; // Clear existing QR code
            
            // Create a canvas element
            const canvas = document.createElement('canvas');
            
            QRCode.toCanvas(canvas, url, {
                width: 400,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function(error) {
                if (error) {
                    console.error('QR Code generation error:', error);
                    qrContainer.innerHTML = '<p style="color: var(--text-secondary);">QR Code generation failed</p>';
                    return;
                }
                
                canvas.style.width = '200px';
                canvas.style.height = '200px';
                qrContainer.appendChild(canvas);
            });
        }

        // Question Queue Management
        function updateQueueDisplay() {
            const queueList = document.getElementById('queueList');
            
            if (questionQueue.length === 0) {
                queueList.innerHTML = '<p style="color: var(--text-secondary); font-size: 14px;">No questions in queue. Create a new question or import from a quiz.</p>';
                document.getElementById('sendBtn').disabled = true;
            } else {
                queueList.innerHTML = '';
                questionQueue.forEach((question, index) => {
                    const item = document.createElement('div');
                    item.className = 'question-item';
                    
                    const text = document.createElement('div');
                    text.className = 'question-item-text';
                    text.innerHTML = `<strong>${index + 1}.</strong> ${question.text || question.questionText}`;
                    
                    const actions = document.createElement('div');
                    actions.className = 'question-item-actions';
                    
                    if (index > currentQuestionIndex) {
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'btn btn-secondary';
                        removeBtn.style.padding = '4px 8px';
                        removeBtn.style.fontSize = '12px';
                        removeBtn.textContent = 'Remove';
                        removeBtn.onclick = () => removeFromQueue(index);
                        actions.appendChild(removeBtn);
                    }
                    
                    item.appendChild(text);
                    item.appendChild(actions);
                    queueList.appendChild(item);
                });
                
                document.getElementById('sendBtn').disabled = false;
            }
        }

        function removeFromQueue(index) {
            questionQueue.splice(index, 1);
            updateQueueDisplay();
        }

        async function sendNextQuestion() {
            if (currentQuestionIndex + 1 >= questionQueue.length) {
                showToast('No more questions in queue', 'error');
                return;
            }

            currentQuestionIndex++;
            const question = questionQueue[currentQuestionIndex];

            // Normalize question type for student interface compatibility
            const normalizedQuestion = {...question};
            
            // Remove the original 'type' field to avoid confusion
            delete normalizedQuestion.type;
            
            // Map our types to what the student interface expects
            const typeMap = {
                'mcq': 'multiple_choice',
                'tf': 'boolean',  // Try 'boolean' instead of 'true_false'
                'matching': 'matching',
                'ordering': 'ordering',
                'fillblank': 'fill_blank'
            };
            
            // Set both questionType and type to the mapped value
            const mappedType = typeMap[question.type] || question.type;
            normalizedQuestion.questionType = mappedType;
            normalizedQuestion.type = mappedType;
            
            // Ensure questionText is set
            normalizedQuestion.questionText = question.text || question.questionText;
            
            // For true/false, ensure options are properly formatted
            if (question.type === 'tf') {
                normalizedQuestion.options = ['True', 'False'];
            }
            
            // Debug logging
            console.log('Sending question:', {
                sessionId: sessionId,
                endpoint: `https://api.intellaclick.com/api/sessions/${sessionId}/questions`,
                questionData: normalizedQuestion,
                hasQuestionText: !!normalizedQuestion.questionText,
                questionType: normalizedQuestion.questionType
            });

            try {
                const response = await fetch(`https://api.intellaclick.com/api/sessions/${sessionId}/questions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(normalizedQuestion)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error:', {
                        status: response.status,
                        error: errorData
                    });
                    throw new Error(errorData.error || 'Failed to send question');
                }

                const result = await response.json();
                console.log('Question sent successfully:', result);

                showToast('Question sent successfully!', 'success');
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('resultsBtn').disabled = false;
                
                // Display current question
                displayCurrentQuestion(question);
                
                // Update queue display
                updateQueueDisplay();
                
                // Reload session to get updated state
                await loadSession();
            } catch (error) {
                console.error('Error sending question:', error);
                
                // Check if it's a CORS error
                if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
                    showToast('Network error: Unable to reach the API server. This may be a CORS issue.', 'error');
                    console.error('CORS Error Details:', {
                        error: error,
                        message: 'The API server may need to add instructor.intellaclick.com to its allowed origins',
                        currentOrigin: window.location.origin,
                        apiUrl: 'https://api.intellaclick.com'
                    });
                    
                    // Show more detailed error in alert for debugging
                    if (confirm('Network error detected. This is likely a CORS configuration issue.\n\nThe backend needs to add instructor.intellaclick.com to its allowed origins.\n\nClick OK to open the CORS test page for more details.')) {
                        window.open('/cors-test.html', '_blank');
                    }
                } else {
                    showToast(error.message || 'Failed to send question', 'error');
                }
                
                currentQuestionIndex--; // Revert on error
            }
        }

        function displayCurrentQuestion(question) {
            document.getElementById('currentQuestionSection').style.display = 'block';
            document.getElementById('questionText').textContent = question.text || question.questionText;
            
            // Display options based on question type
            const optionsDiv = document.getElementById('questionOptions');
            optionsDiv.innerHTML = '';
            
            if (question.type === 'mcq' && question.optionTexts) {
                question.options.forEach((option, index) => {
                    const optionEl = document.createElement('div');
                    optionEl.style.marginTop = '8px';
                    optionEl.textContent = `${option}: ${question.optionTexts[index]}`;
                    optionsDiv.appendChild(optionEl);
                });
            } else if (question.type === 'tf') {
                optionsDiv.innerHTML = '<div style="margin-top: 8px;">A: True</div><div style="margin-top: 8px;">B: False</div>';
            } else if (question.type === 'matching' && question.pairs) {
                optionsDiv.innerHTML = '<strong>Match the following:</strong>';
                question.pairs.forEach((pair, index) => {
                    const pairEl = document.createElement('div');
                    pairEl.style.marginTop = '8px';
                    pairEl.textContent = `${index + 1}. ${pair.left} → ?`;
                    optionsDiv.appendChild(pairEl);
                });
            } else if (question.type === 'ordering' && question.correctOrder) {
                optionsDiv.innerHTML = '<strong>Put in correct order:</strong>';
                // Shuffle the items for display
                const shuffled = [...question.correctOrder].sort(() => Math.random() - 0.5);
                shuffled.forEach((item, index) => {
                    const itemEl = document.createElement('div');
                    itemEl.style.marginTop = '8px';
                    itemEl.textContent = `${String.fromCharCode(65 + index)}. ${item}`;
                    optionsDiv.appendChild(itemEl);
                });
            }
        }

        // Modal Functions
        function showQuestionModal() {
            document.getElementById('questionModal').style.display = 'block';
            updateModalOptions(); // Initialize with default options
        }

        function closeQuestionModal() {
            document.getElementById('questionModal').style.display = 'none';
            // Clear form
            document.getElementById('modalQuestionText').value = '';
            document.getElementById('modalQuestionType').value = 'mcq';
        }

        function showImportModal() {
            document.getElementById('importModal').style.display = 'block';
            loadQuizzes();
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
            selectedQuizId = null;
        }

        function updateModalOptions() {
            const type = document.getElementById('modalQuestionType').value;
            const optionsDiv = document.getElementById('modalQuestionOptions');
            
            switch(type) {
                case 'mcq':
                    optionsDiv.innerHTML = `
                        <label>Answer Options (select correct answer)</label>
                        <div style="margin-top: 8px;">
                            <input type="radio" name="modalCorrect" value="A" checked> 
                            <input type="text" id="modalOptionA" placeholder="Option A" style="width: calc(100% - 30px); margin-left: 8px;">
                        </div>
                        <div style="margin-top: 8px;">
                            <input type="radio" name="modalCorrect" value="B"> 
                            <input type="text" id="modalOptionB" placeholder="Option B" style="width: calc(100% - 30px); margin-left: 8px;">
                        </div>
                        <div style="margin-top: 8px;">
                            <input type="radio" name="modalCorrect" value="C"> 
                            <input type="text" id="modalOptionC" placeholder="Option C" style="width: calc(100% - 30px); margin-left: 8px;">
                        </div>
                        <div style="margin-top: 8px;">
                            <input type="radio" name="modalCorrect" value="D"> 
                            <input type="text" id="modalOptionD" placeholder="Option D" style="width: calc(100% - 30px); margin-left: 8px;">
                        </div>
                    `;
                    break;
                    
                case 'tf':
                    optionsDiv.innerHTML = `
                        <label>Correct Answer</label>
                        <div style="margin-top: 8px;">
                            <input type="radio" name="modalTF" value="true" checked> True
                            <input type="radio" name="modalTF" value="false" style="margin-left: 20px;"> False
                        </div>
                    `;
                    break;
                    
                case 'matching':
                    optionsDiv.innerHTML = `
                        <label>Matching Pairs</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
                            <input type="text" placeholder="Item 1" id="modalMatch1Left">
                            <input type="text" placeholder="Match 1" id="modalMatch1Right">
                            <input type="text" placeholder="Item 2" id="modalMatch2Left">
                            <input type="text" placeholder="Match 2" id="modalMatch2Right">
                            <input type="text" placeholder="Item 3" id="modalMatch3Left">
                            <input type="text" placeholder="Match 3" id="modalMatch3Right">
                        </div>
                    `;
                    break;
                    
                case 'ordering':
                    optionsDiv.innerHTML = `
                        <label>Items in Correct Order</label>
                        <div style="margin-top: 8px;">
                            <input type="text" placeholder="1st item" id="modalOrder1" style="margin-bottom: 8px;">
                            <input type="text" placeholder="2nd item" id="modalOrder2" style="margin-bottom: 8px;">
                            <input type="text" placeholder="3rd item" id="modalOrder3" style="margin-bottom: 8px;">
                            <input type="text" placeholder="4th item" id="modalOrder4">
                        </div>
                    `;
                    break;
                    
                case 'fillblank':
                    optionsDiv.innerHTML = `
                        <label>Correct Answer</label>
                        <input type="text" id="modalBlankAnswer" placeholder="Enter the correct answer" style="margin-top: 8px;">
                        <small style="display: block; margin-top: 8px; color: var(--text-secondary);">Use [blank] in your question where the answer should go</small>
                    `;
                    break;
            }
        }

        async function stopQuestion() {
            try {
                // Get current question ID from session data
                const questionId = sessionData.currentQuestion?.questionId || 'current';
                
                const response = await fetch(`https://api.intellaclick.com/api/sessions/${sessionId}/questions/${questionId}/end`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Failed to stop question');

                showToast('Question stopped', 'success');
                document.getElementById('currentQuestionSection').style.display = 'none';
                await loadSession();
            } catch (error) {
                console.error('Error stopping question:', error);
                showToast('Failed to stop question', 'error');
            }
        }

        async function showResults() {
            document.getElementById('responsesSection').style.display = 'block';
            // TODO: Implement results display
            showToast('Results feature coming soon', 'info');
        }

        async function endSession() {
            if (!confirm('Are you sure you want to end this session?')) return;

            try {
                const response = await fetch(`https://api.intellaclick.com/api/sessions/${sessionId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ status: 'ended' })
                });

                if (!response.ok) throw new Error('Failed to end session');

                showToast('Session ended', 'success');
                stopPolling();
                setTimeout(() => window.location.href = '/classes.html', 2000);
            } catch (error) {
                console.error('Error ending session:', error);
                showToast('Failed to end session', 'error');
            }
        }

        function startPolling() {
            // Poll for updates every 3 seconds
            pollInterval = setInterval(loadSession, 3000);
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
        }

        function openDisplayView() {
            const displayUrl = `/display.html?id=${sessionId}&code=${sessionCode}`;
            window.open(displayUrl, 'IntellaClickDisplay', 'width=1920,height=1080,menubar=no,toolbar=no,location=no,status=no');
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function copyJoinUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                showToast('Link copied to clipboard!', 'success');
            }).catch(err => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = url;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast('Link copied to clipboard!', 'success');
                } catch (err) {
                    showToast('Failed to copy link', 'error');
                }
                document.body.removeChild(textArea);
            });
        }

        function copySessionCode() {
            const code = document.getElementById('sessionCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showToast('Session code copied!', 'success');
            }).catch(err => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = code;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast('Session code copied!', 'success');
                } catch (err) {
                    showToast('Failed to copy code', 'error');
                }
                document.body.removeChild(textArea);
            });
        }

        // Add Question to Queue
        function addQuestionToQueue() {
            const questionText = document.getElementById('modalQuestionText').value.trim();
            const questionType = document.getElementById('modalQuestionType').value;
            
            if (!questionText) {
                showToast('Please enter a question', 'error');
                return;
            }
            
            let question = {
                text: questionText,
                type: questionType
            };
            
            // Build question based on type
            switch(questionType) {
                case 'mcq':
                    const options = [];
                    const optionTexts = [];
                    let correctAnswer = null;
                    
                    ['A', 'B', 'C', 'D'].forEach(letter => {
                        const optionInput = document.getElementById(`modalOption${letter}`);
                        if (optionInput && optionInput.value.trim()) {
                            options.push(letter);
                            optionTexts.push(optionInput.value.trim());
                            
                            const radio = document.querySelector(`input[name="modalCorrect"][value="${letter}"]`);
                            if (radio && radio.checked) {
                                correctAnswer = letter;
                            }
                        }
                    });
                    
                    if (options.length < 2) {
                        showToast('Please provide at least 2 options', 'error');
                        return;
                    }
                    
                    question.options = options;
                    question.optionTexts = optionTexts;
                    question.correctAnswer = correctAnswer;
                    break;
                    
                case 'tf':
                    question.options = ['True', 'False'];
                    question.correctAnswer = document.querySelector('input[name="modalTF"]:checked').value;
                    break;
                    
                case 'matching':
                    const pairs = [];
                    for (let i = 1; i <= 3; i++) {
                        const left = document.getElementById(`modalMatch${i}Left`).value.trim();
                        const right = document.getElementById(`modalMatch${i}Right`).value.trim();
                        if (left && right) {
                            pairs.push({ left, right });
                        }
                    }
                    
                    if (pairs.length < 2) {
                        showToast('Please provide at least 2 matching pairs', 'error');
                        return;
                    }
                    
                    question.pairs = pairs;
                    break;
                    
                case 'ordering':
                    const items = [];
                    for (let i = 1; i <= 4; i++) {
                        const item = document.getElementById(`modalOrder${i}`).value.trim();
                        if (item) {
                            items.push(item);
                        }
                    }
                    
                    if (items.length < 2) {
                        showToast('Please provide at least 2 items', 'error');
                        return;
                    }
                    
                    question.correctOrder = items;
                    break;
                    
                case 'fillblank':
                    const answer = document.getElementById('modalBlankAnswer').value.trim();
                    if (!answer) {
                        showToast('Please provide the correct answer', 'error');
                        return;
                    }
                    
                    if (!questionText.includes('[blank]')) {
                        showToast('Please include [blank] in your question', 'error');
                        return;
                    }
                    
                    question.correctAnswer = answer;
                    break;
            }
            
            // Add to queue
            questionQueue.push(question);
            updateQueueDisplay();
            closeQuestionModal();
            showToast('Question added to queue', 'success');
        }

        // Load and Import Quizzes
        async function loadQuizzes() {
            try {
                const response = await fetch(`https://api.intellaclick.com/api/quizzes`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load quizzes');

                const data = await response.json();
                const quizzes = data.quizzes || [];

                const quizList = document.getElementById('quizList');
                if (quizzes.length === 0) {
                    quizList.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No quizzes found. <a href="/quizzes.html" style="color: var(--primary-color);">Create your first quiz</a></p>';
                    document.getElementById('importBtn').disabled = true;
                } else {
                    quizList.innerHTML = '';
                    quizzes.forEach(quiz => {
                        const item = document.createElement('div');
                        item.className = 'quiz-item';
                        item.innerHTML = `
                            <strong>${quiz.title}</strong><br>
                            <small style="color: var(--text-secondary);">${quiz.questionCount || 0} questions • ${quiz.totalPoints || 0} points</small>
                        `;
                        item.onclick = () => selectQuiz(quiz._id, item);
                        quizList.appendChild(item);
                    });
                }
            } catch (error) {
                console.error('Error loading quizzes:', error);
                const quizList = document.getElementById('quizList');
                quizList.innerHTML = '<p style="color: var(--danger-color); text-align: center; padding: 20px;">Failed to load quizzes. Please try again.</p>';
            }
        }

        function selectQuiz(quizId, element) {
            selectedQuizId = quizId;
            
            // Update UI
            document.querySelectorAll('.quiz-item').forEach(item => {
                item.classList.remove('selected');
            });
            element.classList.add('selected');
            
            document.getElementById('importBtn').disabled = false;
        }

        async function importSelectedQuiz() {
            if (!selectedQuizId) {
                showToast('Please select a quiz', 'error');
                return;
            }

            try {
                const response = await fetch(`https://api.intellaclick.com/api/quizzes/${selectedQuizId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load quiz');

                const data = await response.json();
                const quiz = data.quiz || data;

                if (quiz.questions && quiz.questions.length > 0) {
                    // Add all quiz questions to the queue
                    quiz.questions.forEach(q => {
                        // Get question data from snapshot if available
                        const snapshot = q.questionSnapshot || q;

                        questionQueue.push({
                            text: snapshot.questionText || q.text || '',
                            type: snapshot.type || 'mcq',
                            options: snapshot.options || [],
                            correctAnswer: snapshot.correctAnswer || 0
                        });
                    });

                    updateQueueDisplay();
                    closeImportModal();
                    showToast(`Imported ${quiz.questions.length} questions from ${quiz.title}`, 'success');
                } else {
                    showToast('Quiz has no questions', 'error');
                }
            } catch (error) {
                console.error('Error importing quiz:', error);
                showToast('Failed to import quiz', 'error');
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', stopPolling);
    </script>
</body>
</html>